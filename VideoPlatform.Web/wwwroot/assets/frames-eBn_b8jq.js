var Ce=Object.defineProperty,_e=l=>{throw TypeError(l)},Te=(l,n,h)=>n in l?Ce(l,n,{enumerable:!0,configurable:!0,writable:!0,value:h}):l[n]=h,et=(l,n,h)=>Te(l,typeof n!="symbol"?n+"":n,h),me=(l,n,h)=>n.has(l)||_e("Cannot "+h),m=(l,n,h)=>(me(l,n,"read from private field"),h?h.call(l):n.get(l)),A=(l,n,h)=>n.has(l)?_e("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(l):n.set(l,h),E=(l,n,h,o)=>(me(l,n,"write to private field"),n.set(l,h),h),ge=l=>{throw TypeError(l)},ye=(l,n,h)=>n.has(l)||ge("Cannot "+h),z=(l,n,h)=>(ye(l,n,"read from private field"),h?h.call(l):n.get(l)),D=(l,n,h)=>n.has(l)?ge("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(l):n.set(l,h),R=(l,n,h,o)=>(ye(l,n,"write to private field"),n.set(l,h),h);const be="KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIHUobil7aWYobj09PSIvIilyZXR1cm57cGFyZW50Om51bGwsbmFtZToiIn07Y29uc3QgZT1uLnNwbGl0KCIvIikuZmlsdGVyKGk9PmkubGVuZ3RoPjApO2lmKGUubGVuZ3RoPT09MCl0aHJvdyBFcnJvcigiSW52YWxpZCBwYXRoIik7Y29uc3QgYT1lW2UubGVuZ3RoLTFdLHI9Ii8iK2Uuc2xpY2UoMCwtMSkuam9pbigiLyIpO3JldHVybntuYW1lOmEscGFyZW50OnJ9fWFzeW5jIGZ1bmN0aW9uIHcobixlKXtjb25zdHtwYXJlbnQ6YSxuYW1lOnJ9PXUobik7aWYoYT09bnVsbClyZXR1cm4gYXdhaXQgbmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7Y29uc3QgaT1hLnNwbGl0KCIvIikuZmlsdGVyKHQ9PnQubGVuZ3RoPjApO3RyeXtsZXQgdD1hd2FpdCBuYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTtmb3IoY29uc3QgcyBvZiBpKXQ9YXdhaXQgdC5nZXREaXJlY3RvcnlIYW5kbGUocyx7Y3JlYXRlOmUuY3JlYXRlfSk7aWYoZS5pc0ZpbGUpcmV0dXJuIGF3YWl0IHQuZ2V0RmlsZUhhbmRsZShyLHtjcmVhdGU6ZS5jcmVhdGV9KX1jYXRjaCh0KXtpZih0Lm5hbWU9PT0iTm90Rm91bmRFcnJvciIpcmV0dXJuIG51bGw7dGhyb3cgdH19Y29uc3QgZj17fTtzZWxmLm9ubWVzc2FnZT1hc3luYyBuPT57dmFyIGk7Y29uc3R7ZXZ0VHlwZTplLGFyZ3M6YX09bi5kYXRhO2xldCByPWZbYS5maWxlSWRdO3RyeXtsZXQgdDtjb25zdCBzPVtdO2lmKGU9PT0icmVnaXN0ZXIiKXtjb25zdCBsPWF3YWl0IHcoYS5maWxlUGF0aCx7Y3JlYXRlOiEwLGlzRmlsZTohMH0pO2lmKGw9PW51bGwpdGhyb3cgRXJyb3IoYG5vdCBmb3VuZCBmaWxlOiAke2EuZmlsZUlkfWApO3I9YXdhaXQgbC5jcmVhdGVTeW5jQWNjZXNzSGFuZGxlKHttb2RlOmEubW9kZX0pLGZbYS5maWxlSWRdPXJ9ZWxzZSBpZihlPT09ImNsb3NlIilhd2FpdCByLmNsb3NlKCksZGVsZXRlIGZbYS5maWxlSWRdO2Vsc2UgaWYoZT09PSJ0cnVuY2F0ZSIpYXdhaXQgci50cnVuY2F0ZShhLm5ld1NpemUpO2Vsc2UgaWYoZT09PSJ3cml0ZSIpe2NvbnN0e2RhdGE6bCxvcHRzOm99PW4uZGF0YS5hcmdzO3Q9YXdhaXQgci53cml0ZShsLG8pfWVsc2UgaWYoZT09PSJyZWFkIil7Y29uc3R7b2Zmc2V0Omwsc2l6ZTpvfT1uLmRhdGEuYXJncyxnPW5ldyBVaW50OEFycmF5KG8pLGQ9YXdhaXQgci5yZWFkKGcse2F0Omx9KSxjPWcuYnVmZmVyO3Q9ZD09PW8/YzooKGk9Yy50cmFuc2Zlcik9PW51bGw/dm9pZCAwOmkuY2FsbChjLGQpKT8/Yy5zbGljZSgwLGQpLHMucHVzaCh0KX1lbHNlIGU9PT0iZ2V0U2l6ZSI/dD1hd2FpdCByLmdldFNpemUoKTplPT09ImZsdXNoIiYmYXdhaXQgci5mbHVzaCgpO3NlbGYucG9zdE1lc3NhZ2Uoe2V2dFR5cGU6ImNhbGxiYWNrIixjYklkOm4uZGF0YS5jYklkLHJldHVyblZhbDp0fSxzKX1jYXRjaCh0KXtjb25zdCBzPXQ7c2VsZi5wb3N0TWVzc2FnZSh7ZXZ0VHlwZToidGhyb3dFcnJvciIsY2JJZDpuLmRhdGEuY2JJZCxlcnJNc2c6cy5uYW1lKyI6ICIrcy5tZXNzYWdlK2AKYCtKU09OLnN0cmluZ2lmeShuLmRhdGEpfSl9fX0pKCk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPW9wZnMtd29ya2VyLUY0UldscWNfLmpzLm1hcAo=",ke=l=>Uint8Array.from(atob(l),n=>n.charCodeAt(0)),ae=typeof self<"u"&&self.Blob&&new Blob([ke(be)],{type:"text/javascript;charset=utf-8"});function Fe(l){let n;try{if(n=ae&&(self.URL||self.webkitURL).createObjectURL(ae),!n)throw"";const h=new Worker(n,{name:l==null?void 0:l.name});return h.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(n)}),h}catch{return new Worker("data:text/javascript;base64,"+be,{name:l==null?void 0:l.name})}finally{n&&(self.URL||self.webkitURL).revokeObjectURL(n)}}async function Pe(l,n,h){const o=Le();return await o("register",{fileId:l,filePath:n,mode:h}),{read:async(d,u)=>await o("read",{fileId:l,offset:d,size:u}),write:async(d,u)=>await o("write",{fileId:l,data:d,opts:u},[ArrayBuffer.isView(d)?d.buffer:d]),close:async()=>await o("close",{fileId:l}),truncate:async d=>await o("truncate",{fileId:l,newSize:d}),getSize:async()=>await o("getSize",{fileId:l}),flush:async()=>await o("flush",{fileId:l})}}const Tt=[];let Xt=0;function Le(){if(Tt.length<3){const n=l();return Tt.push(n),n}else{const n=Tt[Xt];return Xt=(Xt+1)%Tt.length,n}function l(){const n=new Fe;let h=0,o={};return n.onmessage=({data:d})=>{var u,_;d.evtType==="callback"?(u=o[d.cbId])==null||u.resolve(d.returnVal):d.evtType==="throwError"&&((_=o[d.cbId])==null||_.reject(Error(d.errMsg))),delete o[d.cbId]},async function(d,u,_=[]){h+=1;const s=new Promise((b,x)=>{o[h]={resolve:b,reject:x}});return n.postMessage({cbId:h,evtType:d,args:u},_),s}}}function Zt(l){if(l==="/")return{parent:null,name:""};const n=l.split("/").filter(d=>d.length>0);if(n.length===0)throw Error("Invalid path");const h=n[n.length-1],o="/"+n.slice(0,-1).join("/");return{name:h,parent:o}}async function tt(l,n){const{parent:h,name:o}=Zt(l);if(h==null)return await navigator.storage.getDirectory();const d=h.split("/").filter(u=>u.length>0);try{let u=await navigator.storage.getDirectory();for(const _ of d)u=await u.getDirectoryHandle(_,{create:n.create});return n.isFile?await u.getFileHandle(o,{create:n.create}):await u.getDirectoryHandle(o,{create:n.create})}catch(u){if(u.name==="NotFoundError")return null;throw u}}async function ve(l){const{parent:n,name:h}=Zt(l);if(n==null){const d=await navigator.storage.getDirectory();for await(const u of d.keys())await d.removeEntry(u,{recursive:!0});return}const o=await tt(n,{create:!1,isFile:!1});o!=null&&await o.removeEntry(h,{recursive:!0})}function Qt(l,n){return`${l}/${n}`.replace("//","/")}function ct(l){return new we(l)}var N,kt,bt;class we{constructor(n){D(this,N),D(this,kt),D(this,bt),R(this,N,n);const{parent:h,name:o}=Zt(n);R(this,kt,o),R(this,bt,h)}get kind(){return"dir"}get name(){return z(this,kt)}get path(){return z(this,N)}get parent(){return z(this,bt)==null?null:ct(z(this,bt))}async create(){return await tt(z(this,N),{create:!0,isFile:!1}),ct(z(this,N))}async exists(){return await tt(z(this,N),{create:!1,isFile:!1})instanceof FileSystemDirectoryHandle}async remove(){for(const n of await this.children())try{await n.remove()}catch(h){console.warn(h)}try{await ve(z(this,N))}catch(n){console.warn(n)}}async children(){const n=await tt(z(this,N),{create:!1,isFile:!1});if(n==null)return[];const h=[];for await(const o of n.values())h.push((o.kind==="file"?at:ct)(Qt(z(this,N),o.name)));return h}async copyTo(n){if(!await this.exists())throw Error(`dir ${this.path} not exists`);const h=await n.exists()?ct(Qt(n.path,this.name)):n;return await h.create(),await Promise.all((await this.children()).map(o=>o.copyTo(h))),h}async moveTo(n){const h=await this.copyTo(n);return await this.remove(),h}}N=new WeakMap,kt=new WeakMap,bt=new WeakMap;const oe=new Map;function at(l,n="rw"){if(n==="rw"){const h=oe.get(l)??new Vt(l,n);return oe.set(l,h),h}return new Vt(l,n)}async function re(l,n,h={overwrite:!0}){if(n instanceof Vt){await re(l,await n.stream(),h);return}const o=await(l instanceof Vt?l:at(l,"rw")).createWriter();try{if(h.overwrite&&await o.truncate(0),n instanceof ReadableStream){const d=n.getReader();for(;;){const{done:u,value:_}=await d.read();if(u)break;await o.write(_)}}else await o.write(n)}catch(d){throw d}finally{await o.close()}}let Re=0;const De=()=>++Re;var O,vt,Ft,wt,Pt,K,Lt,St;const Me=class Se{constructor(n,h){D(this,O),D(this,vt),D(this,Ft),D(this,wt),D(this,Pt),D(this,K,0),D(this,Lt,(()=>{let u=null;return()=>(R(this,K,z(this,K)+1),u??(u=new Promise(async(_,s)=>{try{const b=await Pe(z(this,Pt),z(this,O),z(this,wt));_([b,async()=>{R(this,K,z(this,K)-1),!(z(this,K)>0)&&(u=null,await b.close())}])}catch(b){s(b)}})))})()),D(this,St,!1),R(this,Pt,De()),R(this,O,n),R(this,wt,{r:"read-only",rw:"readwrite","rw-unsafe":"readwrite-unsafe"}[h]);const{parent:o,name:d}=Zt(n);R(this,Ft,d),R(this,vt,o)}get kind(){return"file"}get path(){return z(this,O)}get name(){return z(this,Ft)}get parent(){return z(this,vt)==null?null:ct(z(this,vt))}async createWriter(){if(z(this,wt)==="read-only")throw Error("file is read-only");if(z(this,St))throw Error("Other writer have not been closed");R(this,St,!0);const n=new TextEncoder,[h,o]=await z(this,Lt).call(this);let d=await h.getSize(),u=!1;return{write:async(_,s={})=>{if(u)throw Error("Writer is closed");const b=typeof _=="string"?n.encode(_):_,x=s.at??d,y=b.byteLength;return d=x+y,await h.write(b,{at:x})},truncate:async _=>{if(u)throw Error("Writer is closed");await h.truncate(_),d>_&&(d=_)},flush:async()=>{if(u)throw Error("Writer is closed");await h.flush()},close:async()=>{if(u)throw Error("Writer is closed");u=!0,R(this,St,!1),await o()}}}async createReader(){const[n,h]=await z(this,Lt).call(this);let o=!1,d=0;return{read:async(u,_={})=>{if(o)throw Error("Reader is closed");const s=_.at??d,b=await n.read(s,u);return d=s+b.byteLength,b},getSize:async()=>{if(o)throw Error("Reader is closed");return await n.getSize()},close:async()=>{o||(o=!0,await h())}}}async text(){return new TextDecoder().decode(await this.arrayBuffer())}async arrayBuffer(){const n=await tt(z(this,O),{create:!1,isFile:!0});return n==null?new ArrayBuffer(0):(await n.getFile()).arrayBuffer()}async stream(){const n=await this.getOriginFile();return n==null?new ReadableStream({pull:h=>{h.close()}}):n.stream()}async getOriginFile(){var n;return(n=await tt(z(this,O),{create:!1,isFile:!0}))==null?void 0:n.getFile()}async getSize(){const n=await tt(z(this,O),{create:!1,isFile:!0});return n==null?0:(await n.getFile()).size}async exists(){return await tt(z(this,O),{create:!1,isFile:!0})instanceof FileSystemFileHandle}async remove(){if(z(this,K))throw Error("exists unclosed reader/writer");await ve(z(this,O))}async copyTo(n){if(!await this.exists())throw Error(`file ${this.path} not exists`);if(n instanceof Se)return at(n.path)===this?this:(await re(n.path,this),at(n.path));if(n instanceof we)return await this.copyTo(at(Qt(n.path,this.name)));throw Error("Illegal target type")}async moveTo(n){const h=await this.copyTo(n);return await this.remove(),h}};O=new WeakMap,vt=new WeakMap,Ft=new WeakMap,wt=new WeakMap,Pt=new WeakMap,K=new WeakMap,Lt=new WeakMap,St=new WeakMap;let Vt=Me;const ne="/.opfs-tools-temp-dir";async function Ue(l){try{if(l.kind==="file"){if(!await l.exists())return!0;const n=await l.createWriter();await n.truncate(0),await n.close(),await l.remove()}else await l.remove();return!0}catch(n){return console.warn(n),!1}}function Ne(){setInterval(async()=>{for(const l of await ct(ne).children()){const n=/^\d+-(\d+)$/.exec(l.name);(n==null||Date.now()-Number(n[1])>2592e5)&&await Ue(l)}},60*1e3)}const Jt=[];let he=!1;async function Oe(){if(globalThis.localStorage==null)return;const l="OPFS_TOOLS_EXPIRES_TMP_FILES";he||(he=!0,globalThis.addEventListener("unload",()=>{Jt.length!==0&&localStorage.setItem(l,`${localStorage.getItem(l)??""},${Jt.join(",")}`)}));let n=localStorage.getItem(l)??"";for(const h of n.split(","))h.length!==0&&await Ue(at(`${ne}/${h}`))&&(n=n.replace(h,""));localStorage.setItem(l,n.replace(/,{2,}/g,","))}(async function(){var l;globalThis.__opfs_tools_tmpfile_init__!==!0&&(globalThis.__opfs_tools_tmpfile_init__=!0,!(globalThis.FileSystemDirectoryHandle==null||globalThis.FileSystemFileHandle==null||((l=globalThis.navigator)==null?void 0:l.storage.getDirectory)==null)&&(Ne(),await Oe()))})();function xe(){const l=`${Math.random().toString().slice(2)}-${Date.now()}`;return Jt.push(l),at(`${ne}/${l}`)}function Ge(l){return l instanceof Error?String(l):typeof l=="object"?JSON.stringify(l,(n,h)=>h instanceof Error?String(h):h):String(l)}function Ye(){const l=new Date;return`${l.getHours()}:${l.getMinutes()}:${l.getSeconds()}.${l.getMilliseconds()}`}let Ee=1;const Ae=xe();let zt=null;const le=["debug","info","warn","error"].reduce((l,n,h)=>Object.assign(l,{[n]:(...o)=>{Ee<=h&&(console[n](...o),zt==null||zt.write(`[${n}][${Ye()}]  ${o.map(d=>Ge(d)).join(" ")}
`))}}),{}),It=new Map,k={setLogLevel:l=>{Ee=It.get(l)??1},...le,create:l=>Object.fromEntries(Object.entries(le).map(([n,h])=>[n,(...o)=>h(l,...o)])),async dump(){return await We,await(zt==null?void 0:zt.flush()),await Ae.text()}};It.set(k.debug,0);It.set(k.info,1);It.set(k.warn,2);It.set(k.error,3);async function He(){try{zt=await Ae.createWriter(),k.info(navigator.userAgent),k.info("date: "+new Date().toLocaleDateString())}catch(l){if(!(l instanceof Error))throw l;if(l.message.includes("createSyncAccessHandle is not a function"))console.warn(l);else throw l}}const We=globalThis.navigator==null?null:He(),Ve=()=>{let l,n=16.6;self.onmessage=h=>{h.data.event==="start"&&(self.clearInterval(l),l=self.setInterval(()=>{self.postMessage({})},n)),h.data.event==="stop"&&self.clearInterval(l)}},Ze=()=>{const l=new Blob([`(${Ve.toString()})()`]),n=URL.createObjectURL(l);return new Worker(n)},ht=new Map;let qt=1,_t=null;globalThis.Worker!=null&&(_t=Ze(),_t.onmessage=()=>{qt+=1;for(const[l,n]of ht)if(qt%l===0)for(const h of n)h()});const je=(l,n)=>{const h=Math.round(n/16.6),o=ht.get(h)??new Set;return o.add(l),ht.set(h,o),ht.size===1&&o.size===1&&(_t==null||_t.postMessage({event:"start"})),()=>{o.delete(l),o.size===0&&ht.delete(h),ht.size===0&&(qt=0,_t==null||_t.postMessage({event:"stop"}))}};class Xe{constructor(n,h,o){this.length_=n,this.scaleFactor_=(n-1)/h,this.interpolate=this.cubic,o.method==="point"?this.interpolate=this.point:o.method==="linear"?this.interpolate=this.linear:o.method==="sinc"&&(this.interpolate=this.sinc),this.tangentFactor_=1-Math.max(0,Math.min(1,o.tension||0)),this.sincFilterSize_=o.sincFilterSize||1,this.kernel_=Qe(o.sincWindow||Ke)}point(n,h){return this.getClippedInput_(Math.round(this.scaleFactor_*n),h)}linear(n,h){n=this.scaleFactor_*n;let o=Math.floor(n);return n-=o,(1-n)*this.getClippedInput_(o,h)+n*this.getClippedInput_(o+1,h)}cubic(n,h){n=this.scaleFactor_*n;let o=Math.floor(n),d=[this.getTangent_(o,h),this.getTangent_(o+1,h)],u=[this.getClippedInput_(o,h),this.getClippedInput_(o+1,h)];n-=o;let _=n*n,s=n*_;return(2*s-3*_+1)*u[0]+(s-2*_+n)*d[0]+(-2*s+3*_)*u[1]+(s-_)*d[1]}sinc(n,h){n=this.scaleFactor_*n;let o=Math.floor(n),d=o-this.sincFilterSize_+1,u=o+this.sincFilterSize_,_=0;for(let s=d;s<=u;s++)_+=this.kernel_(n-s)*this.getClippedInput_(s,h);return _}getTangent_(n,h){return this.tangentFactor_*(this.getClippedInput_(n+1,h)-this.getClippedInput_(n-1,h))/2}getClippedInput_(n,h){return 0<=n&&n<this.length_?h[n]:0}}function Ke(l){return Math.exp(-l/2*l/2)}function Qe(l){return function(n){return Je(n)*l(n)}}function Je(l){return l===0?1:Math.sin(Math.PI*l)/(Math.PI*l)}class qe{constructor(n,h,o){let d=2*Math.PI*o/h,u=0;this.filters=[];for(let _=0;_<=n;_++)_-n/2===0?this.filters[_]=d:(this.filters[_]=Math.sin(d*(_-n/2))/(_-n/2),this.filters[_]*=.54-.46*Math.cos(2*Math.PI*_/n)),u=u+this.filters[_];for(let _=0;_<=n;_++)this.filters[_]/=u;this.z=this.initZ_()}filter(n){this.z.buf[this.z.pointer]=n;let h=0;for(let o=0,d=this.z.buf.length;o<d;o++)h+=this.filters[o]*this.z.buf[(this.z.pointer+o)%this.z.buf.length];return this.z.pointer=(this.z.pointer+1)%this.z.buf.length,h}reset(){this.z=this.initZ_()}initZ_(){let n=[];for(let h=0;h<this.filters.length-1;h++)n.push(0);return{buf:n,pointer:0}}}class $e{constructor(n,h,o){let d=[];for(let u=0;u<n;u++)d.push(this.getCoeffs_({Fs:h,Fc:o,Q:.5/Math.sin(Math.PI/(n*2)*(u+.5))}));this.stages=[];for(let u=0;u<d.length;u++)this.stages[u]={b0:d[u].b[0],b1:d[u].b[1],b2:d[u].b[2],a1:d[u].a[0],a2:d[u].a[1],k:d[u].k,z:[0,0]}}filter(n){let h=n;for(let o=0,d=this.stages.length;o<d;o++)h=this.runStage_(o,h);return h}getCoeffs_(n){let h={};h.z=[0,0],h.a=[],h.b=[];let o=this.preCalc_(n,h);return h.k=1,h.b.push((1-o.cw)/(2*o.a0)),h.b.push(2*h.b[0]),h.b.push(h.b[0]),h}preCalc_(n,h){let o={},d=2*Math.PI*n.Fc/n.Fs;return o.alpha=Math.sin(d)/(2*n.Q),o.cw=Math.cos(d),o.a0=1+o.alpha,h.a0=o.a0,h.a.push(-2*o.cw/o.a0),h.k=1,h.a.push((1-o.alpha)/o.a0),o}runStage_(n,h){let o=h*this.stages[n].k-this.stages[n].a1*this.stages[n].z[0]-this.stages[n].a2*this.stages[n].z[1],d=this.stages[n].b0*o+this.stages[n].b1*this.stages[n].z[0]+this.stages[n].b2*this.stages[n].z[1];return this.stages[n].z[1]=this.stages[n].z[0],this.stages[n].z[0]=o,d}reset(){for(let n=0;n<this.stages.length;n++)this.stages[n].z=[0,0]}}const ti={point:!1,linear:!1,cubic:!0,sinc:!0},de={IIR:16,FIR:71},ei={IIR:$e,FIR:qe};function ii(l,n,h,o={}){let d=(h-n)/n+1,u=new Float64Array(l.length*d);o.method=o.method||"cubic";let _=new Xe(l.length,u.length,{method:o.method,tension:o.tension||0,sincFilterSize:o.sincFilterSize||6,sincWindow:o.sincWindow||void 0});if(o.LPF===void 0&&(o.LPF=ti[o.method]),o.LPF){o.LPFType=o.LPFType||"IIR";const s=ei[o.LPFType];if(h>n){let b=new s(o.LPFOrder||de[o.LPFType],h,n/2);si(l,u,_,b)}else{let b=new s(o.LPFOrder||de[o.LPFType],n,h/2);ri(l,u,_,b)}}else Be(l,u,_);return u}function Be(l,n,h){for(let o=0,d=n.length;o<d;o++)n[o]=h.interpolate(o,l)}function si(l,n,h,o){for(let d=0,u=n.length;d<u;d++)n[d]=o.filter(h.interpolate(d,l));o.reset();for(let d=n.length-1;d>=0;d--)n[d]=o.filter(n[d])}function ri(l,n,h,o){for(let d=0,u=l.length;d<u;d++)l[d]=o.filter(l[d]);o.reset();for(let d=l.length-1;d>=0;d--)l[d]=o.filter(l[d]);Be(l,n,h)}function ni(l){if(l.format==="f32-planar"){const n=[];for(let h=0;h<l.numberOfChannels;h+=1){const o=l.allocationSize({planeIndex:h}),d=new ArrayBuffer(o);l.copyTo(d,{planeIndex:h}),n.push(new Float32Array(d))}return n}else if(l.format==="f32"){const n=new ArrayBuffer(l.allocationSize({planeIndex:0}));return l.copyTo(n,{planeIndex:0}),oi(new Float32Array(n),l.numberOfChannels)}else if(l.format==="s16"){const n=new ArrayBuffer(l.allocationSize({planeIndex:0}));return l.copyTo(n,{planeIndex:0}),ai(new Int16Array(n),l.numberOfChannels)}throw Error("Unsupported audio data format")}function ai(l,n){const h=l.length/n,o=Array.from({length:n},()=>new Float32Array(h));for(let d=0;d<h;d++)for(let u=0;u<n;u++){const _=l[d*n+u];o[u][d]=_/32768}return o}function oi(l,n){const h=l.length/n,o=Array.from({length:n},()=>new Float32Array(h));for(let d=0;d<h;d++)for(let u=0;u<n;u++)o[u][d]=l[d*n+u];return o}function hi(l){return Array(l.numberOfChannels).fill(0).map((n,h)=>l.getChannelData(h))}async function li(l,n,h){const o=l.length,d=Array(h.chanCount).fill(0).map(()=>new Float32Array(0));if(o===0)return d;const u=Math.max(...l.map(x=>x.length));if(u===0)return d;if(globalThis.OfflineAudioContext==null)return l.map(x=>new Float32Array(ii(x,n,h.rate,{method:"sinc",LPF:!1})));const _=new globalThis.OfflineAudioContext(h.chanCount,u*h.rate/n,h.rate),s=_.createBufferSource(),b=_.createBuffer(o,u,n);return l.forEach((x,y)=>b.copyToChannel(x,y)),s.buffer=b,s.connect(_.destination),s.start(),hi(await _.startRendering())}function ze(l){return new Promise(n=>{const h=je(()=>{h(),n()},l)})}function di(l,n){let h=!1;async function o(){const d=l.getReader();for(;!h;){const{value:u,done:_}=await d.read();if(_){n.onDone();return}await n.onChunk(u)}d.releaseLock(),await l.cancel()}return o().catch(k.error),()=>{h=!0}}function pi(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var Ie={};(function(l){var n=function(){var t=new Date,e=4,i=3,r=2,a=1,p=e,f={setLogLevel:function(c){c==this.debug?p=a:c==this.info?p=r:c==this.warn?p=i:(c==this.error,p=e)},debug:function(c,g){console.debug===void 0&&(console.debug=console.log),a>=p&&console.debug("["+n.getDurationString(new Date-t,1e3)+"]","["+c+"]",g)},log:function(c,g){this.debug(c.msg)},info:function(c,g){r>=p&&console.info("["+n.getDurationString(new Date-t,1e3)+"]","["+c+"]",g)},warn:function(c,g){i>=p&&console.warn("["+n.getDurationString(new Date-t,1e3)+"]","["+c+"]",g)},error:function(c,g){e>=p&&console.error("["+n.getDurationString(new Date-t,1e3)+"]","["+c+"]",g)}};return f}();n.getDurationString=function(t,e){var i;function r(w,v){for(var U=""+w,I=U.split(".");I[0].length<v;)I[0]="0"+I[0];return I.join(".")}t<0?(i=!0,t=-t):i=!1;var a=e||1,p=t/a,f=Math.floor(p/3600);p-=f*3600;var c=Math.floor(p/60);p-=c*60;var g=p*1e3;return p=Math.floor(p),g-=p*1e3,g=Math.floor(g),(i?"-":"")+f+":"+r(c,2)+":"+r(p,2)+"."+r(g,3)},n.printRanges=function(t){var e=t.length;if(e>0){for(var i="",r=0;r<e;r++)r>0&&(i+=","),i+="["+n.getDurationString(t.start(r))+","+n.getDurationString(t.end(r))+"]";return i}else return"(empty)"},l.Log=n;var h=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};h.prototype.getPosition=function(){return this.position},h.prototype.getEndPosition=function(){return this.buffer.byteLength},h.prototype.getLength=function(){return this.buffer.byteLength},h.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},h.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},h.prototype.readAnyInt=function(t,e){var i=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?i=this.dataview.getInt8(this.position):i=this.dataview.getUint8(this.position);break;case 2:e?i=this.dataview.getInt16(this.position):i=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";i=this.dataview.getUint8(this.position)<<16,i|=this.dataview.getUint8(this.position+1)<<8,i|=this.dataview.getUint8(this.position+2);break;case 4:e?i=this.dataview.getInt32(this.position):i=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";i=this.dataview.getUint32(this.position)<<32,i|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,i}else throw"Not enough bytes in buffer"},h.prototype.readUint8=function(){return this.readAnyInt(1,!1)},h.prototype.readUint16=function(){return this.readAnyInt(2,!1)},h.prototype.readUint24=function(){return this.readAnyInt(3,!1)},h.prototype.readUint32=function(){return this.readAnyInt(4,!1)},h.prototype.readUint64=function(){return this.readAnyInt(8,!1)},h.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",i=0;i<t;i++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},h.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},h.prototype.readInt8=function(){return this.readAnyInt(1,!0)},h.prototype.readInt16=function(){return this.readAnyInt(2,!0)},h.prototype.readInt32=function(){return this.readAnyInt(4,!0)},h.prototype.readInt64=function(){return this.readAnyInt(8,!1)},h.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),i=0;i<t;i++)e[i]=this.readUint8();return e},h.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.readInt16();return e},h.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.readUint16();return e},h.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),i=0;i<t;i++)e[i]=this.readUint32();return e},h.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),i=0;i<t;i++)e[i]=this.readInt32();return e},l.MP4BoxStream=h;var o=function(t,e,i){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=i??o.LITTLE_ENDIAN};o.prototype={},o.prototype.getPosition=function(){return this.position},o.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,i=this._buffer.byteLength;if(e<=i){e>this._byteLength&&(this._byteLength=e);return}for(i<1&&(i=1);e>i;)i*=2;var r=new ArrayBuffer(i),a=new Uint8Array(this._buffer),p=new Uint8Array(r,0,a.length);p.set(a),this.buffer=r,this._byteLength=e}},o.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),i=new Uint8Array(this._buffer,0,e.length);e.set(i),this.buffer=t}},o.BIG_ENDIAN=!1,o.LITTLE_ENDIAN=!0,o.prototype._byteLength=0,Object.defineProperty(o.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(o.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(o.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(o.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),o.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},o.prototype.isEof=function(){return this.position>=this._byteLength},o.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},o.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var i=new Int32Array(t);return o.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),o.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},o.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var i=new Int16Array(t);return o.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),o.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},o.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return o.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},o.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var i=new Uint32Array(t);return o.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),o.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},o.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var i=new Uint16Array(t);return o.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),o.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},o.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return o.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},o.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var i=new Float64Array(t);return o.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),o.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},o.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var i=new Float32Array(t);return o.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),o.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},o.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e},o.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e},o.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},o.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e},o.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e},o.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},o.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e},o.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e},o.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,o.memcpy=function(t,e,i,r,a){var p=new Uint8Array(t,e,a),f=new Uint8Array(i,r,a);p.set(f)},o.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},o.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},o.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i=0;i<t.byteLength;i+=t.BYTES_PER_ELEMENT)for(var r=i+t.BYTES_PER_ELEMENT-1,a=i;r>a;r--,a++){var p=e[a];e[a]=e[r],e[r]=p}return t},o.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return String.fromCharCode.apply(null,e)},o.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},o.prototype.readCString=function(t){var e=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position),r=e;t!=null&&(r=Math.min(t,e));for(var a=0;a<r&&i[a]!==0;a++);var p=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(a)]);return t!=null?this.position+=r-a:a!=e&&(this.position+=1),p};var d=Math.pow(2,32);o.prototype.readInt64=function(){return this.readInt32()*d+this.readUint32()},o.prototype.readUint64=function(){return this.readUint32()*d+this.readUint32()},o.prototype.readInt64=function(){return this.readUint32()*d+this.readUint32()},o.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},l.DataStream=o,o.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.setAttribute("href",i),r.setAttribute("download",t),r.setAttribute("target","_self"),r.click(),window.URL.revokeObjectURL(i)}else throw"DataStream.save: Can't create object URL."},o.prototype._dynamicSize=!0,Object.defineProperty(o.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),o.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),i=new Uint8Array(e),r=new Uint8Array(this._buffer,t,i.length);i.set(r),this.buffer=e,this.position-=t},o.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt32(t[i],e)},o.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt16(t[i],e)},o.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},o.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint32(t[i],e)},o.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint16(t[i],e)},o.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},o.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat64(t[i],e)},o.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat32(t[i],e)},o.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4},o.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2},o.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},o.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4},o.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2},o.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},o.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4},o.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8},o.prototype.writeUCS2String=function(t,e,i){i==null&&(i=t.length);for(var r=0;r<t.length&&r<i;r++)this.writeUint16(t.charCodeAt(r),e);for(;r<i;r++)this.writeUint16(0)},o.prototype.writeString=function(t,e,i){var r=0;if(e==null||e=="ASCII")if(i!=null){var a=Math.min(t.length,i);for(r=0;r<a;r++)this.writeUint8(t.charCodeAt(r));for(;r<i;r++)this.writeUint8(0)}else for(r=0;r<t.length;r++)this.writeUint8(t.charCodeAt(r));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,i)))},o.prototype.writeCString=function(t,e){var i=0;if(e!=null){var r=Math.min(t.length,e);for(i=0;i<r;i++)this.writeUint8(t.charCodeAt(i));for(;i<e;i++)this.writeUint8(0)}else{for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));this.writeUint8(0)}},o.prototype.writeStruct=function(t,e){for(var i=0;i<t.length;i+=2){var r=t[i+1];this.writeType(r,e[t[i]],e)}},o.prototype.writeType=function(t,e,i){var r;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,i);var a=null,p="ASCII",f=this.position;switch(typeof t=="string"&&/:/.test(t)&&(r=t.split(":"),t=r[0],a=parseInt(r[1])),typeof t=="string"&&/,/.test(t)&&(r=t.split(","),t=r[0],p=parseInt(r[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,o.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,o.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,o.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,o.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,o.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,o.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,o.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,o.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,o.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,o.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,o.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,o.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,a);break;case"string":this.writeString(e,p,a);break;case"u16string":this.writeUCS2String(e,this.endianness,a);break;case"u16stringle":this.writeUCS2String(e,o.LITTLE_ENDIAN,a);break;case"u16stringbe":this.writeUCS2String(e,o.BIG_ENDIAN,a);break;default:if(t.length==3){for(var c=t[1],g=0;g<e.length;g++)this.writeType(c,e[g]);break}else{this.writeStruct(t,e);break}}a!=null&&(this.position=f,this._realloc(a),this.position=f+a)},o.prototype.writeUint64=function(t){var e=Math.floor(t/d);this.writeUint32(e),this.writeUint32(t&4294967295)},o.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},o.prototype.adjustUint32=function(t,e){var i=this.position;this.seek(t),this.writeUint32(e),this.seek(i)},o.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var i=new Int32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(i,e??this.endianness),this.position+=t*4,i},o.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var i=new Int16Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(i,e??this.endianness),this.position+=t*2,i},o.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},o.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var i=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(i,e??this.endianness),this.position+=t*4,i},o.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var i=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(i,e??this.endianness),this.position+=t*2,i},o.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var i=new Float64Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(i,e??this.endianness),this.position+=t*8,i},o.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var i=new Float32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(i,e??this.endianness),this.position+=t*4,i};var u=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};u.prototype=new o(new ArrayBuffer,0,o.BIG_ENDIAN),u.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,n.debug("MultiBufferStream","Stream ready for parsing"),!0):(n.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(n.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){n.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i.buffer},u.prototype.reduceBuffer=function(t,e,i){var r;return r=new Uint8Array(i),r.set(new Uint8Array(t,e,i)),r.buffer.fileStart=t.fileStart+e,r.buffer.usedBytes=0,r.buffer},u.prototype.insertBuffer=function(t){for(var e=!0,i=0;i<this.buffers.length;i++){var r=this.buffers[i];if(t.fileStart<=r.fileStart){if(t.fileStart===r.fileStart)if(t.byteLength>r.byteLength){this.buffers.splice(i,1),i--;continue}else n.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=r.fileStart||(t=this.reduceBuffer(t,0,r.fileStart-t.fileStart)),n.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(i,0,t),i===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<r.fileStart+r.byteLength){var a=r.fileStart+r.byteLength-t.fileStart,p=t.byteLength-a;if(p>0)t=this.reduceBuffer(t,a,p);else{e=!1;break}}}e&&(n.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),i===0&&(this.buffer=t))},u.prototype.logBufferLevel=function(t){var e,i,r,a,p=[],f,c="";for(r=0,a=0,e=0;e<this.buffers.length;e++)i=this.buffers[e],e===0?(f={},p.push(f),f.start=i.fileStart,f.end=i.fileStart+i.byteLength,c+="["+f.start+"-"):f.end===i.fileStart?f.end=i.fileStart+i.byteLength:(f={},f.start=i.fileStart,c+=p[p.length-1].end-1+"], ["+f.start+"-",f.end=i.fileStart+i.byteLength,p.push(f)),r+=i.usedBytes,a+=i.byteLength;p.length>0&&(c+=f.end-1+"]");var g=t?n.info:n.debug;this.buffers.length===0?g("MultiBufferStream","No more buffer in memory"):g("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+r+"/"+a+" bytes), continuous ranges: "+c)},u.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(n.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},u.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,i=this.buffer.usedBytes,r=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=i,this.buffer.fileStart=r,n.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},u.prototype.findPosition=function(t,e,i){var r,a=null,p=-1;for(t===!0?r=0:r=this.bufferIndex;r<this.buffers.length&&(a=this.buffers[r],a.fileStart<=e);)p=r,i&&(a.fileStart+a.byteLength<=e?a.usedBytes=a.byteLength:a.usedBytes=e-a.fileStart,this.logBufferLevel()),r++;return p!==-1?(a=this.buffers[p],a.fileStart+a.byteLength>=e?(n.debug("MultiBufferStream","Found position in existing buffer #"+p),p):-1):-1},u.prototype.findEndContiguousBuf=function(t){var e,i,r,a=t!==void 0?t:this.bufferIndex;if(i=this.buffers[a],this.buffers.length>a+1)for(e=a+1;e<this.buffers.length&&(r=this.buffers[e],r.fileStart===i.fileStart+i.byteLength);e++)i=r;return i.fileStart+i.byteLength},u.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},u.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},u.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},u.prototype.seek=function(t,e,i){var r;return r=this.findPosition(e,t,i),r!==-1?(this.buffer=this.buffers[r],this.bufferIndex=r,this.position=t-this.buffer.fileStart,n.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(n.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},u.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},u.prototype.getLength=function(){return this.byteLength},u.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},l.MultiBufferStream=u;var _=function(){var t=3,e=4,i=5,r=6,a=[];a[t]="ES_Descriptor",a[e]="DecoderConfigDescriptor",a[i]="DecoderSpecificInfo",a[r]="SLConfigDescriptor",this.getDescriptorName=function(c){return a[c]};var p=this,f={};return this.parseOneDescriptor=function(c){var g=0,w,v,U;for(w=c.readUint8(),U=c.readUint8();U&128;)g=(U&127)<<7,U=c.readUint8();return g+=U&127,n.debug("MPEG4DescriptorParser","Found "+(a[w]||"Descriptor "+w)+", size "+g+" at position "+c.getPosition()),a[w]?v=new f[a[w]](g):v=new f.Descriptor(g),v.parse(c),v},f.Descriptor=function(c,g){this.tag=c,this.size=g,this.descs=[]},f.Descriptor.prototype.parse=function(c){this.data=c.readUint8Array(this.size)},f.Descriptor.prototype.findDescriptor=function(c){for(var g=0;g<this.descs.length;g++)if(this.descs[g].tag==c)return this.descs[g];return null},f.Descriptor.prototype.parseRemainingDescriptors=function(c){for(var g=c.position;c.position<g+this.size;){var w=p.parseOneDescriptor(c);this.descs.push(w)}},f.ES_Descriptor=function(c){f.Descriptor.call(this,t,c)},f.ES_Descriptor.prototype=new f.Descriptor,f.ES_Descriptor.prototype.parse=function(c){if(this.ES_ID=c.readUint16(),this.flags=c.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=c.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var g=c.readUint8();this.URL=c.readString(g),this.size-=g+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=c.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(c)},f.ES_Descriptor.prototype.getOTI=function(c){var g=this.findDescriptor(e);return g?g.oti:0},f.ES_Descriptor.prototype.getAudioConfig=function(c){var g=this.findDescriptor(e);if(!g)return null;var w=g.findDescriptor(i);if(w&&w.data){var v=(w.data[0]&248)>>3;return v===31&&w.data.length>=2&&(v=32+((w.data[0]&7)<<3)+((w.data[1]&224)>>5)),v}else return null},f.DecoderConfigDescriptor=function(c){f.Descriptor.call(this,e,c)},f.DecoderConfigDescriptor.prototype=new f.Descriptor,f.DecoderConfigDescriptor.prototype.parse=function(c){this.oti=c.readUint8(),this.streamType=c.readUint8(),this.bufferSize=c.readUint24(),this.maxBitrate=c.readUint32(),this.avgBitrate=c.readUint32(),this.size-=13,this.parseRemainingDescriptors(c)},f.DecoderSpecificInfo=function(c){f.Descriptor.call(this,i,c)},f.DecoderSpecificInfo.prototype=new f.Descriptor,f.SLConfigDescriptor=function(c){f.Descriptor.call(this,r,c)},f.SLConfigDescriptor.prototype=new f.Descriptor,this};l.MPEG4DescriptorParser=_;var s={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){s.FullBox.prototype=new s.Box,s.ContainerBox.prototype=new s.Box,s.SampleEntry.prototype=new s.Box,s.TrackGroupTypeBox.prototype=new s.FullBox,s.BASIC_BOXES.forEach(function(t){s.createBoxCtor(t)}),s.FULL_BOXES.forEach(function(t){s.createFullBoxCtor(t)}),s.CONTAINER_BOXES.forEach(function(t){s.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,i){this.type=t,this.size=e,this.uuid=i},FullBox:function(t,e,i){s.Box.call(this,t,e,i),this.flags=0,this.version=0},ContainerBox:function(t,e,i){s.Box.call(this,t,e,i),this.boxes=[]},SampleEntry:function(t,e,i,r){s.ContainerBox.call(this,t,e),this.hdr_size=i,this.start=r},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){s.FullBox.call(this,t,e)},createBoxCtor:function(t,e){s.boxCodes.push(t),s[t+"Box"]=function(i){s.Box.call(this,t,i)},s[t+"Box"].prototype=new s.Box,e&&(s[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){s[t+"Box"]=function(i){s.FullBox.call(this,t,i)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(i){this.parseFullHeader(i),e&&e.call(this,i)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,i=0;i<e;i++)this[t[i]+"s"]=[]}},createContainerBoxCtor:function(t,e,i){s[t+"Box"]=function(r){s.ContainerBox.call(this,t,r),s.addSubBoxArrays.call(this,i)},s[t+"Box"].prototype=new s.ContainerBox,e&&(s[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,i){s.sampleEntryCodes[t]=[],s[t+"SampleEntry"]=function(r,a){s.SampleEntry.call(this,r,a),s.addSubBoxArrays.call(this,i)},s[t+"SampleEntry"].prototype=new s.SampleEntry,e&&(s[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,i,r){s.sampleEntryCodes[t].push(e),s[e+"SampleEntry"]=function(a){s[t+"SampleEntry"].call(this,e,a),s.addSubBoxArrays.call(this,r)},s[e+"SampleEntry"].prototype=new s[t+"SampleEntry"],i&&(s[e+"SampleEntry"].prototype.parse=i)},createEncryptedSampleEntryCtor:function(t,e,i){s.createSampleEntryCtor.call(this,t,e,i,["sinf"])},createSampleGroupCtor:function(t,e){s[t+"SampleGroupEntry"]=function(i){s.SampleGroupEntry.call(this,t,i)},s[t+"SampleGroupEntry"].prototype=new s.SampleGroupEntry,e&&(s[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){s[t+"TrackGroupTypeBox"]=function(i){s.TrackGroupTypeBox.call(this,t,i)},s[t+"TrackGroupTypeBox"].prototype=new s.TrackGroupTypeBox,e&&(s[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,i,r){s.UUIDs.push(t),s.UUIDBoxes[t]=function(a){e?s.FullBox.call(this,"uuid",a,t):i?s.ContainerBox.call(this,"uuid",a,t):s.Box.call(this,"uuid",a,t)},s.UUIDBoxes[t].prototype=e?new s.FullBox:i?new s.ContainerBox:new s.Box,r&&(e?s.UUIDBoxes[t].prototype.parse=function(a){this.parseFullHeader(a),r&&r.call(this,a)}:s.UUIDBoxes[t].prototype.parse=r)}};s.initialize(),s.TKHD_FLAG_ENABLED=1,s.TKHD_FLAG_IN_MOVIE=2,s.TKHD_FLAG_IN_PREVIEW=4,s.TFHD_FLAG_BASE_DATA_OFFSET=1,s.TFHD_FLAG_SAMPLE_DESC=2,s.TFHD_FLAG_SAMPLE_DUR=8,s.TFHD_FLAG_SAMPLE_SIZE=16,s.TFHD_FLAG_SAMPLE_FLAGS=32,s.TFHD_FLAG_DUR_EMPTY=65536,s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,s.TRUN_FLAGS_DATA_OFFSET=1,s.TRUN_FLAGS_FIRST_FLAG=4,s.TRUN_FLAGS_DURATION=256,s.TRUN_FLAGS_SIZE=512,s.TRUN_FLAGS_FLAGS=1024,s.TRUN_FLAGS_CTS_OFFSET=2048,s.Box.prototype.add=function(t){return this.addBox(new s[t+"Box"])},s.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},s.Box.prototype.set=function(t,e){return this[t]=e,this},s.Box.prototype.addEntry=function(t,e){var i=e||"entries";return this[i]||(this[i]=[]),this[i].push(t),this},l.BoxParser=s,s.parseUUID=function(t){return s.parseHex16(t)},s.parseHex16=function(t){for(var e="",i=0;i<16;i++){var r=t.readUint8().toString(16);e+=r.length===1?"0"+r:r}return e},s.parseOneBox=function(t,e,i){var r,a=t.getPosition(),p=0,f,c;if(t.getEndPosition()-a<8)return n.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:s.ERR_NOT_ENOUGH_DATA};if(i&&i<8)return n.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:s.ERR_NOT_ENOUGH_DATA};var g=t.readUint32(),w=t.readString(4),v=w;if(n.debug("BoxParser","Found box of type '"+w+"' and size "+g+" at position "+a),p=8,w=="uuid"){if(t.getEndPosition()-t.getPosition()<16||i-p<16)return t.seek(a),n.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:s.ERR_NOT_ENOUGH_DATA};c=s.parseUUID(t),p+=16,v=c}if(g==1){if(t.getEndPosition()-t.getPosition()<8||i&&i-p<8)return t.seek(a),n.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+w+'" box'),{code:s.ERR_NOT_ENOUGH_DATA};g=t.readUint64(),p+=8}else if(g===0){if(i)g=i;else if(w!=="mdat")return n.error("BoxParser","Unlimited box size not supported for type: '"+w+"'"),r=new s.Box(w,g),{code:s.OK,box:r,size:r.size}}return g!==0&&g<p?(n.error("BoxParser","Box of type "+w+" has an invalid size "+g+" (too small to be a box)"),{code:s.ERR_NOT_ENOUGH_DATA,type:w,size:g,hdr_size:p,start:a}):g!==0&&i&&g>i?(n.error("BoxParser","Box of type '"+w+"' has a size "+g+" greater than its container size "+i),{code:s.ERR_NOT_ENOUGH_DATA,type:w,size:g,hdr_size:p,start:a}):g!==0&&a+g>t.getEndPosition()?(t.seek(a),n.info("BoxParser","Not enough data in stream to parse the entire '"+w+"' box"),{code:s.ERR_NOT_ENOUGH_DATA,type:w,size:g,hdr_size:p,start:a}):e?{code:s.OK,type:w,size:g,hdr_size:p,start:a}:(s[w+"Box"]?r=new s[w+"Box"](g):w!=="uuid"?(n.warn("BoxParser","Unknown box type: '"+w+"'"),r=new s.Box(w,g),r.has_unparsed_data=!0):s.UUIDBoxes[c]?r=new s.UUIDBoxes[c](g):(n.warn("BoxParser","Unknown uuid type: '"+c+"'"),r=new s.Box(w,g),r.uuid=c,r.has_unparsed_data=!0),r.hdr_size=p,r.start=a,r.write===s.Box.prototype.write&&r.type!=="mdat"&&(n.info("BoxParser","'"+v+"' box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(t)),r.parse(t),f=t.getPosition()-(r.start+r.size),f<0?(n.warn("BoxParser","Parsing of box '"+v+"' did not read the entire indicated box data size (missing "+-f+" bytes), seeking forward"),t.seek(r.start+r.size)):f>0&&(n.error("BoxParser","Parsing of box '"+v+"' read "+f+" more bytes than the indicated box data size, seeking backwards"),r.size!==0&&t.seek(r.start+r.size)),{code:s.OK,box:r,size:r.size})},s.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},s.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},s.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.ContainerBox.prototype.parse=function(t){for(var e,i;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)if(i=e.box,this.boxes.push(i),this.subBoxNames&&this.subBoxNames.indexOf(i.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(i.type)]+"s"].push(i);else{var r=i.type!=="uuid"?i.type:i.uuid;this[r]?n.warn("Box of type "+r+" already stored in field of this type"):this[r]=i}else return},s.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},s.SAMPLE_ENTRY_TYPE_VISUAL="Visual",s.SAMPLE_ENTRY_TYPE_AUDIO="Audio",s.SAMPLE_ENTRY_TYPE_HINT="Hint",s.SAMPLE_ENTRY_TYPE_METADATA="Metadata",s.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",s.SAMPLE_ENTRY_TYPE_SYSTEM="System",s.SAMPLE_ENTRY_TYPE_TEXT="Text",s.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},s.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},s.SampleEntry.prototype.parseFooter=function(t){s.ContainerBox.prototype.parse.call(this,t)},s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_HINT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT,"enct"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"encm"),s.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,i=((e&1)+1)*16;this.layer_size=[];for(var r=0;r<3;r++)i==16?this.layer_size[r]=t.readUint16():this.layer_size[r]=t.readUint32()}),s.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),s.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),s.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){n.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){n.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){n.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){n.error("av1C reserved_2 parsing problem");return}var i=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(i)}),s.createBoxCtor("avcC",function(t){var e,i;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,i=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),i-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),i--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),i-=2+this.PPS[e].length;i>0&&(this.ext=t.readUint8Array(i))}),s.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),s.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),s.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),s.createFullBoxCtor("co64",function(t){var e,i;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(i=0;i<e;i++)this.chunk_offsets.push(t.readUint64())}),s.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),s.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),s.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),s.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),s.createFullBoxCtor("ctts",function(t){var e,i;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(i=0;i<e;i++){this.sample_counts.push(t.readUint32());var r=t.readInt32();r<0&&n.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(r)}else if(this.version==1)for(i=0;i<e;i++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),s.createBoxCtor("dac3",function(t){var e=t.readUint8(),i=t.readUint8(),r=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|i>>6&3,this.acmod=i>>3&7,this.lfeon=i>>2&1,this.bit_rate_code=i&3|r>>5&7}),s.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var i=0;i<this.num_ind_sub+1;i++){var r={};this.ind_subs.push(r);var a=t.readUint8(),p=t.readUint8(),f=t.readUint8();r.fscod=a>>6,r.bsid=a>>1&31,r.bsmod=(a&1)<<4|p>>4&15,r.acmod=p>>1&7,r.lfeon=p&1,r.num_dep_sub=f>>1&15,r.num_dep_sub>0&&(r.chan_loc=(f&1)<<8|t.readUint8())}}),s.createFullBoxCtor("dfLa",function(t){var e=127,i=128,r=[],a=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];this.parseFullHeader(t);do{var p=t.readUint8(),f=Math.min(p&e,a.length-1);if(f?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),r.push(a[f]),p&i)break}while(!0);this.numMetadataBlocks=r.length+" ("+r.join(", ")+")"}),s.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),s.createFullBoxCtor("dref",function(t){var e,i;this.entries=[];for(var r=t.readUint32(),a=0;a<r;a++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)i=e.box,this.entries.push(i);else return}),s.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var r={};this.entries.push(r),this.version===1?(r.segment_duration=t.readUint64(),r.media_time=t.readInt64()):(r.segment_duration=t.readUint32(),r.media_time=t.readInt32()),r.media_rate_integer=t.readInt16(),r.media_rate_fraction=t.readInt16()}}),s.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),s.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(typeof _<"u"){var i=new _;this.esd=i.parseOneDescriptor(new o(e.buffer,0,o.BIG_ENDIAN))}}),s.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),s.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),s.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var i=0;e>=4;)this.compatible_brands[i]=t.readString(4),e-=4,i++}),s.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),s.createBoxCtor("hvcC",function(t){var e,i,r,a;this.configurationVersion=t.readUint8(),a=t.readUint8(),this.general_profile_space=a>>6,this.general_tier_flag=(a&32)>>5,this.general_profile_idc=a&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),a=t.readUint8(),this.constantFrameRate=a>>6,this.numTemporalLayers=(a&13)>>3,this.temporalIdNested=(a&4)>>2,this.lengthSizeMinusOne=a&3,this.nalu_arrays=[];var p=t.readUint8();for(e=0;e<p;e++){var f=[];this.nalu_arrays.push(f),a=t.readUint8(),f.completeness=(a&128)>>7,f.nalu_type=a&63;var c=t.readUint16();for(i=0;i<c;i++){var g={};f.push(g),r=t.readUint16(),g.data=t.readUint8Array(r)}}}),s.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var i=0;i<this.entry_count;i++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)e.box.type!=="infe"&&n.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[i]=e.box;else return}),s.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var i=0;if(this.version<2)i=t.readUint16();else if(this.version===2)i=t.readUint32();else throw"version of iloc box not supported";for(var r=0;r<i;r++){var a={};if(this.items.push(a),this.version<2)a.item_ID=t.readUint16();else if(this.version===2)a.item_ID=t.readUint16();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?a.construction_method=t.readUint16()&15:a.construction_method=0,a.data_reference_index=t.readUint16(),this.base_offset_size){case 0:a.base_offset=0;break;case 4:a.base_offset=t.readUint32();break;case 8:a.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var p=t.readUint16();a.extents=[];for(var f=0;f<p;f++){var c={};if(a.extents.push(c),this.version===1||this.version===2)switch(this.index_size){case 0:c.extent_index=0;break;case 4:c.extent_index=t.readUint32();break;case 8:c.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:c.extent_offset=0;break;case 4:c.extent_offset=t.readUint32();break;case 8:c.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:c.extent_length=0;break;case 4:c.extent_length=t.readUint32();break;case 8:c.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),s.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),s.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),n.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),s.createFullBoxCtor("ipma",function(t){var e,i;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var r={};this.associations.push(r),this.version<1?r.id=t.readUint16():r.id=t.readUint32();var a=t.readUint8();for(r.props=[],i=0;i<a;i++){var p=t.readUint8(),f={};r.props.push(f),f.essential=(p&128)>>7===1,this.flags&1?f.property_index=(p&127)<<8|t.readUint8():f.property_index=p&127}}}),s.createFullBoxCtor("iref",function(t){var e,i;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)this.version===0?i=new s.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):i=new s.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),i.write===s.Box.prototype.write&&i.type!=="mdat"&&(n.warn("BoxParser",i.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(t)),i.parse(t),this.references.push(i);else return}),s.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),s.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),s.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),s.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var i=0;i<e;i++){var r={};this.levels[i]=r,r.track_ID=t.readUint32();var a=t.readUint8();switch(r.padding_flag=a>>7,r.assignment_type=a&127,r.assignment_type){case 0:r.grouping_type=t.readString(4);break;case 1:r.grouping_type=t.readString(4),r.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:r.sub_track_id=t.readUint32();break;default:n.warn("BoxParser","Unknown leva assignement type")}}}),s.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),s.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()}),s.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]={},this.display_primaries[0].x=t.readUint16(),this.display_primaries[0].y=t.readUint16(),this.display_primaries[1]={},this.display_primaries[1].x=t.readUint16(),this.display_primaries[1].y=t.readUint16(),this.display_primaries[2]={},this.display_primaries[2].x=t.readUint16(),this.display_primaries[2].y=t.readUint16(),this.white_point={},this.white_point.x=t.readUint16(),this.white_point.y=t.readUint16(),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),s.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),s.createFullBoxCtor("mehd",function(t){this.flags&1&&(n.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),s.createFullBoxCtor("meta",function(t){this.boxes=[],s.ContainerBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),s.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),s.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),s.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),s.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),s.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var i=0;i<Math.floor((e+1)/2);i++)this.padbits=t.readUint8()}),s.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),s.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),s.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var i=0;i<e;i++)this.rate[i]=t.readUint32(),this.initial_delay[i]=t.readUint32()}),s.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),s.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),s.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),s.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),s.createFullBoxCtor("pssh",function(t){if(this.system_id=s.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var i=0;i<e;i++)this.kid[i]=s.parseHex16(t)}var r=t.readUint32();r>0&&(this.data=t.readUint8Array(r))}),s.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),s.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),s.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var i=0;i<e;i++)this.version===0?this.offset[i]=t.readUint32():this.offset[i]=t.readUint64()}),s.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var i=0;i<e;i++)this.sample_info_size[i]=t.readUint8()}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),s.createSampleGroupCtor("alst",function(t){var e,i=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<i;e++)this.sample_offset[e]=t.readUint32();var r=this.description_length-4-4*i;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<r/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),s.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),s.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var i=t.readUint8(),r=0;r<i;r++){var a={};this.dependency.push(a),a.subSeqDirectionFlag=t.readUint8(),a.layerNumber=t.readUint8(),a.subSequenceIdentifier=t.readUint16()}}),s.createSampleGroupCtor("dtrt",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("mvif",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),s.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),s.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)n.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),s.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),s.SampleGroupEntry.prototype.parse=function(t){n.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},s.createSampleGroupCtor("scif",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("scnm",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=s.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),s.createSampleGroupCtor("stsa",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),s.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),s.createSampleGroupCtor("tsas",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("tscl",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("vipr",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var r={};this.entries.push(r),r.sample_count=t.readInt32(),r.group_description_index=t.readInt32()}}),s.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),s.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("sdtp",function(t){var e,i=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var r=0;r<i;r++)e=t.readUint8(),this.is_leading[r]=e>>6,this.sample_depends_on[r]=e>>4&3,this.sample_is_depended_on[r]=e>>2&3,this.sample_has_redundancy[r]=e&3}),s.createFullBoxCtor("senc"),s.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),n.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var r;s[this.grouping_type+"SampleGroupEntry"]?r=new s[this.grouping_type+"SampleGroupEntry"](this.grouping_type):r=new s.SampleGroupEntry(this.grouping_type),this.entries.push(r),this.version===1?this.default_length===0?r.description_length=t.readUint32():r.description_length=this.default_length:r.description_length=this.default_length,r.write===s.SampleGroupEntry.prototype.write&&(n.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),r.data=t.readUint8Array(r.description_length),t.position-=r.description_length),r.parse(t)}}),s.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),i=0;i<e;i++){var r={};this.references.push(r);var a=t.readUint32();r.reference_type=a>>31&1,r.referenced_size=a&2147483647,r.subsegment_duration=t.readUint32(),a=t.readUint32(),r.starts_with_SAP=a>>31&1,r.SAP_type=a>>28&7,r.SAP_delta_time=a&268435455}}),s.SingleItemTypeReferenceBox=function(t,e,i,r){s.Box.call(this,t,e),this.hdr_size=i,this.start=r},s.SingleItemTypeReferenceBox.prototype=new s.Box,s.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var i=0;i<e;i++)this.references[i]=t.readUint16()},s.SingleItemTypeReferenceBoxLarge=function(t,e,i,r){s.Box.call(this,t,e),this.hdr_size=i,this.start=r},s.SingleItemTypeReferenceBoxLarge.prototype=new s.Box,s.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var i=0;i<e;i++)this.references[i]=t.readUint32()},s.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),s.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),s.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),i=0;i<e;i++){var r={};this.subsegments.push(r),r.ranges=[];for(var a=t.readUint32(),p=0;p<a;p++){var f={};r.ranges.push(f),f.level=t.readUint8(),f.range_size=t.readUint24()}}}),s.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var i=0;i<e;i++)this.chunk_offsets.push(t.readUint32())}),s.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var i=0;i<e;i++)this.priority[i]=t.readUint16()}),s.createFullBoxCtor("sthd"),s.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var i=0;i<e;i++)this.attribute_list[i]=t.readUint32()}),s.createFullBoxCtor("stsc",function(t){var e,i;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(i=0;i<e;i++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),s.createFullBoxCtor("stsd",function(t){var e,i,r,a;for(this.entries=[],r=t.readUint32(),e=1;e<=r;e++)if(i=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),i.code===s.OK)s[i.type+"SampleEntry"]?(a=new s[i.type+"SampleEntry"](i.size),a.hdr_size=i.hdr_size,a.start=i.start):(n.warn("BoxParser","Unknown sample entry type: "+i.type),a=new s.SampleEntry(i.type,i.size,i.hdr_size,i.start)),a.write===s.SampleEntry.prototype.write&&(n.info("BoxParser","SampleEntry "+a.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),a.parseDataAndRewind(t)),a.parse(t),this.entries.push(a);else return}),s.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var i=0;i<e;i++)this.group_description_index[i]=t.readUint32()}),s.createFullBoxCtor("stsh",function(t){var e,i;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(i=0;i<e;i++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stss",function(t){var e,i;if(i=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<i;e++)this.sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),s.createFullBoxCtor("stts",function(t){var e,i,r;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(i=0;i<e;i++)this.sample_counts.push(t.readUint32()),r=t.readInt32(),r<0&&(n.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),r=1),this.sample_deltas.push(r)}),s.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var i=t.readUint32();this.stereo_indication_type=t.readString(i);var r,a;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(r=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),r.code===s.OK)a=r.box,this.boxes.push(a),this[a.type]=a;else return}),s.createBoxCtor("styp",function(t){s.ftypBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("stz2",function(t){var e,i;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),i=t.readUint32(),this.field_size===4)for(e=0;e<i;e+=2){var r=t.readUint8();this.sample_sizes[e]=r>>4&15,this.sample_sizes[e+1]=r&15}else if(this.field_size===8)for(e=0;e<i;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<i;e++)this.sample_sizes[e]=t.readUint16();else n.error("BoxParser","Error in length field in stz2 box")}),s.createFullBoxCtor("subs",function(t){var e,i,r,a;for(r=t.readUint32(),this.entries=[],e=0;e<r;e++){var p={};if(this.entries[e]=p,p.sample_delta=t.readUint32(),p.subsamples=[],a=t.readUint16(),a>0)for(i=0;i<a;i++){var f={};p.subsamples.push(f),this.version==1?f.size=t.readUint32():f.size=t.readUint16(),f.priority=t.readUint8(),f.discardable=t.readUint8(),f.codec_specific_parameters=t.readUint32()}}}),s.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=s.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),s.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),s.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),s.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var i=t.readUint32(),r=0;r<i;r++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),s.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),s.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),s.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),s.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},s.createTrackGroupCtor("msrc"),s.TrackReferenceTypeBox=function(t,e,i,r){s.Box.call(this,t,e),this.hdr_size=i,this.start=r},s.TrackReferenceTypeBox.prototype=new s.Box,s.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},s.trefBox.prototype.parse=function(t){for(var e,i;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)i=new s.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),i.write===s.Box.prototype.write&&i.type!=="mdat"&&(n.info("BoxParser","TrackReference "+i.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(t)),i.parse(t),this.boxes.push(i);else return},s.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===s.OK)box=ret.box,this.boxes.push(box);else return}),s.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),s.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var i=0;i<this.sample_count;i++)this.flags&s.TRUN_FLAGS_DURATION&&(this.sample_duration[i]=t.readUint32()),this.flags&s.TRUN_FLAGS_SIZE&&(this.sample_size[i]=t.readUint32()),this.flags&s.TRUN_FLAGS_FLAGS&&(this.sample_flags[i]=t.readUint32()),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[i]=t.readUint32():this.sample_composition_time_offset[i]=t.readInt32())}),s.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var i=0;i<e;i++)this.attribute_list[i]=t.readUint32()}),s.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),s.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),s.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),s.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),s.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=s.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),s.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),s.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=s.parseHex16(t)}),s.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var i={},r=0,a=0;this.version===1?(r=t.readUint64(),a=t.readUint64()):(r=t.readUint32(),a=t.readUint32()),i.absolute_time=r,i.absolute_duration=a,this.entries.push(i)}}),s.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),s.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),s.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),s.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("vvcC",function(t){var e,i,r={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(S){this.held_bits=S.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(S){this.held_bits=S.readUint16(),this.num_held_bits=16},extract_bits:function(S){var T=this.held_bits>>this.num_held_bits-S&(1<<S)-1;return this.num_held_bits-=S,T}};if(r.stream_read_1_bytes(t),r.extract_bits(5),this.lengthSizeMinusOne=r.extract_bits(2),this.ptl_present_flag=r.extract_bits(1),this.ptl_present_flag){r.stream_read_2_bytes(t),this.ols_idx=r.extract_bits(9),this.num_sublayers=r.extract_bits(3),this.constant_frame_rate=r.extract_bits(2),this.chroma_format_idc=r.extract_bits(2),r.stream_read_1_bytes(t),this.bit_depth_minus8=r.extract_bits(3),r.extract_bits(5);{if(r.stream_read_2_bytes(t),r.extract_bits(2),this.num_bytes_constraint_info=r.extract_bits(6),this.general_profile_idc=r.extract_bits(7),this.general_tier_flag=r.extract_bits(1),this.general_level_idc=t.readUint8(),r.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=r.extract_bits(1),this.ptl_multilayer_enabled_flag=r.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var a=r.extract_bits(6);r.stream_read_1_bytes(t);var p=r.extract_bits(2);this.general_constraint_info[e]=a<<2|p}this.general_constraint_info[this.num_bytes_constraint_info-1]=r.extract_bits(6)}else r.extract_bits(6);for(r.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,i=this.num_sublayers-2;i>=0;--i){var f=r.extract_bits(1);this.ptl_sublayer_present_mask|=f<<i}for(i=this.num_sublayers;i<=8&&this.num_sublayers>1;++i)r.extract_bits(1);for(i=this.num_sublayers-2;i>=0;--i)this.ptl_sublayer_present_mask&1<<i&&(this.sublayer_level_idc[i]=t.readUint8());if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var c=12,g=13;this.nalu_arrays=[];var w=t.readUint8();for(e=0;e<w;e++){var v=[];this.nalu_arrays.push(v),r.stream_read_1_bytes(t),v.completeness=r.extract_bits(1),r.extract_bits(2),v.nalu_type=r.extract_bits(5);var U=1;for(v.nalu_type!=g&&v.nalu_type!=c&&(U=t.readUint16()),i=0;i<U;i++){var I=t.readUint16();v.push({data:t.readUint8Array(I),length:I})}}}),s.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3}),s.SampleEntry.prototype.isVideo=function(){return!1},s.SampleEntry.prototype.isAudio=function(){return!1},s.SampleEntry.prototype.isSubtitle=function(){return!1},s.SampleEntry.prototype.isMetadata=function(){return!1},s.SampleEntry.prototype.isHint=function(){return!1},s.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},s.SampleEntry.prototype.getWidth=function(){return""},s.SampleEntry.prototype.getHeight=function(){return""},s.SampleEntry.prototype.getChannelCount=function(){return""},s.SampleEntry.prototype.getSampleRate=function(){return""},s.SampleEntry.prototype.getSampleSize=function(){return""},s.VisualSampleEntry.prototype.isVideo=function(){return!0},s.VisualSampleEntry.prototype.getWidth=function(){return this.width},s.VisualSampleEntry.prototype.getHeight=function(){return this.height},s.AudioSampleEntry.prototype.isAudio=function(){return!0},s.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},s.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},s.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},s.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},s.MetadataSampleEntry.prototype.isMetadata=function(){return!0},s.decimalToHex=function(t,e){var i=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;i.length<e;)i="0"+i;return i},s.avc1SampleEntry.prototype.getCodec=s.avc2SampleEntry.prototype.getCodec=s.avc3SampleEntry.prototype.getCodec=s.avc4SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+s.decimalToHex(this.avcC.AVCProfileIndication)+s.decimalToHex(this.avcC.profile_compatibility)+s.decimalToHex(this.avcC.AVCLevelIndication):t},s.hev1SampleEntry.prototype.getCodec=s.hvc1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var i=this.hvcC.general_profile_compatibility,r=0;for(t=0;t<32&&(r|=i&1,t!=31);t++)r<<=1,i>>=1;e+=s.decimalToHex(r,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var a=!1,p="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||a)&&(p="."+s.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+p,a=!0);e+=p}return e},s.vvc1SampleEntry.prototype.getCodec=s.vvi1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var i="";if(this.vvcC.general_constraint_info){var r=[],a=0;a|=this.vvcC.ptl_frame_only_constraint<<7,a|=this.vvcC.ptl_multilayer_enabled<<6;var p;for(t=0;t<this.vvcC.general_constraint_info.length;++t)a|=this.vvcC.general_constraint_info[t]>>2&63,r.push(a),a&&(p=t),a=this.vvcC.general_constraint_info[t]>>2&3;if(p===void 0)i=".CA";else{i=".C";var f="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",c=0,g=0;for(t=0;t<=p;++t)for(c=c<<8|r[t],g+=8;g>=5;){var w=c>>g-5&31;i+=f[w],g-=5,c&=(1<<g)-1}g&&(c<<=5-g,i+=f[c&31])}}e+=i}return e},s.mp4aSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),i=this.esds.esd.getAudioConfig();return t+"."+s.decimalToHex(e)+(i?"."+i:"")}else return t},s.stxtSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},s.vp08SampleEntry.prototype.getCodec=s.vp09SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var i=this.vpcC.bitDepth;return i==8&&(i="08"),t+".0"+this.vpcC.profile+"."+e+"."+i},s.av01SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var i;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?i=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(i=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+i},s.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>d&&(this.size+=8),this.type==="uuid"&&(this.size+=16),n.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>d?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>d&&t.writeUint64(this.size)},s.FullBox.prototype.writeHeader=function(t){this.size+=4,s.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},s.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},s.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},s.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},s.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},s.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},s.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},s.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},s.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeUint32(i.segment_duration),t.writeInt32(i.media_time),t.writeInt16(i.media_rate_integer),t.writeInt16(i.media_rate_fraction)}},s.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},s.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},s.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},s.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},s.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},s.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},s.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},s.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},s.SampleEntry.prototype.writeHeader=function(t){this.size=8,s.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},s.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},s.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},s.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},s.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},s.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeInt32(i.sample_count),t.writeInt32(i.group_description_index)}},s.sgpdBox.prototype.write=function(t){var e,i;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)i=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=i.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)i=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(i.description_length),i.write(t)},s.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var i=this.references[e];t.writeUint32(i.reference_type<<31|i.referenced_size),t.writeUint32(i.subsegment_duration),t.writeUint32(i.starts_with_SAP<<31|i.SAP_type<<28|i.SAP_delta_time)}},s.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},s.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},s.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},s.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},s.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},s.stszBox.prototype.write=function(t){var e,i=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){i=!1;break}else e++;else i=!1;this.size=8,i||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),i?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),i||t.writeUint32Array(this.sample_sizes)},s.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},s.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},s.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},s.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},s.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},s.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&s.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&s.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&s.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&s.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&s.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&s.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},s["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},s["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},s.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},s.cttsBox.prototype.unpack=function(t){var e,i,r;for(r=0,e=0;e<this.sample_counts.length;e++)for(i=0;i<this.sample_counts[e];i++)t[r].pts=t[r].dts+this.sample_offsets[e],r++},s.sttsBox.prototype.unpack=function(t){var e,i,r;for(r=0,e=0;e<this.sample_counts.length;e++)for(i=0;i<this.sample_counts[e];i++)r===0?t[r].dts=0:t[r].dts=t[r-1].dts+this.sample_deltas[e],r++},s.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},s.stscBox.prototype.unpack=function(t){var e,i,r,a,p;for(a=0,p=0,e=0;e<this.first_chunk.length;e++)for(i=0;i<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);i++)for(p++,r=0;r<this.samples_per_chunk[e];r++){if(t[a])t[a].description_index=this.sample_description_index[e],t[a].chunk_index=p;else return;a++}},s.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},s.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],s.boxEqualFields=function(t,e){if(t&&!e)return!1;var i;for(i in t)if(!(s.DIFF_BOXES_PROP_NAMES.indexOf(i)>-1)){if(t[i]instanceof s.Box||e[i]instanceof s.Box||typeof t[i]>"u"||typeof e[i]>"u"||typeof t[i]=="function"||typeof e[i]=="function"||t.subBoxNames&&t.subBoxNames.indexOf(i.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(i.slice(0,4))>-1||i==="data"||i==="start"||i==="size"||i==="creation_time"||i==="modification_time"||s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(i)>-1)continue;if(t[i]!==e[i])return!1}return!0},s.boxEqual=function(t,e){if(!s.boxEqualFields(t,e))return!1;for(var i=0;i<s.DIFF_BOXES_PROP_NAMES.length;i++){var r=s.DIFF_BOXES_PROP_NAMES[i];if(t[r]&&e[r]&&!s.boxEqual(t[r],e[r]))return!1}return!0};var b=function(){};b.prototype.parseSample=function(t){var e={},i;e.resources=[];var r=new h(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=r.readString(t.data.length);else if(e.documentString=r.readString(t.subsamples[0].size),t.subsamples.length>1)for(i=1;i<t.subsamples.length;i++)e.resources[i]=r.readUint8Array(t.subsamples[i].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var x=function(){};x.prototype.parseSample=function(t){var e,i=new h(t.data.buffer);return e=i.readString(t.data.length),e},x.prototype.parseConfig=function(t){var e,i=new h(t.buffer);return i.readUint32(),e=i.readCString(),e},l.XMLSubtitlein4Parser=b,l.Textin4Parser=x;var y=function(t){this.stream=t||new u,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};y.prototype.setSegmentOptions=function(t,e,i){var r=this.getTrackById(t);if(r){var a={};this.fragmentedTracks.push(a),a.id=t,a.user=e,a.trak=r,r.nextSample=0,a.segmentStream=null,a.nb_samples=1e3,a.rapAlignement=!0,i&&(i.nbSamples&&(a.nb_samples=i.nbSamples),i.rapAlignement&&(a.rapAlignement=i.rapAlignement))}},y.prototype.unsetSegmentOptions=function(t){for(var e=-1,i=0;i<this.fragmentedTracks.length;i++){var r=this.fragmentedTracks[i];r.id==t&&(e=i)}e>-1&&this.fragmentedTracks.splice(e,1)},y.prototype.setExtractionOptions=function(t,e,i){var r=this.getTrackById(t);if(r){var a={};this.extractedTracks.push(a),a.id=t,a.user=e,a.trak=r,r.nextSample=0,a.nb_samples=1e3,a.samples=[],i&&i.nbSamples&&(a.nb_samples=i.nbSamples)}},y.prototype.unsetExtractionOptions=function(t){for(var e=-1,i=0;i<this.extractedTracks.length;i++){var r=this.extractedTracks[i];r.id==t&&(e=i)}e>-1&&this.extractedTracks.splice(e,1)},y.prototype.parse=function(){var t,e,i=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=s.parseOneBox(this.stream,i),t.code===s.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var r;switch(e=t.box,r=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),r){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[r]!==void 0&&n.warn("ISOFile","Duplicate Box of type: "+r+", overriding previous occurrence"),this[r]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},y.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(n.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(n.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(n.warn("ISOFile","Not ready to start parsing"),!1))},y.prototype.appendBuffer=function(t,e){var i;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(i=this.nextSeekPosition,this.nextSeekPosition=void 0):i=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(i=this.stream.getEndFilePositionAfter(i))):this.nextParsePosition?i=this.nextParsePosition:i=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(n.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+i),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),n.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),i},y.prototype.getInfo=function(){var t,e,i={},r,a,p,f,c=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(i.hasMoov=!0,i.duration=this.moov.mvhd.duration,i.timescale=this.moov.mvhd.timescale,i.isFragmented=this.moov.mvex!=null,i.isFragmented&&this.moov.mvex.mehd&&(i.fragment_duration=this.moov.mvex.mehd.fragment_duration),i.isProgressive=this.isProgressive,i.hasIOD=this.moov.iods!=null,i.brands=[],i.brands.push(this.ftyp.major_brand),i.brands=i.brands.concat(this.ftyp.compatible_brands),i.created=new Date(c+this.moov.mvhd.creation_time*1e3),i.modified=new Date(c+this.moov.mvhd.modification_time*1e3),i.tracks=[],i.audioTracks=[],i.videoTracks=[],i.subtitleTracks=[],i.metadataTracks=[],i.hintTracks=[],i.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(r=this.moov.traks[t],f=r.mdia.minf.stbl.stsd.entries[0],a={},i.tracks.push(a),a.id=r.tkhd.track_id,a.name=r.mdia.hdlr.name,a.references=[],r.tref)for(e=0;e<r.tref.boxes.length;e++)p={},a.references.push(p),p.type=r.tref.boxes[e].type,p.track_ids=r.tref.boxes[e].track_ids;r.edts&&(a.edits=r.edts.elst.entries),a.created=new Date(c+r.tkhd.creation_time*1e3),a.modified=new Date(c+r.tkhd.modification_time*1e3),a.movie_duration=r.tkhd.duration,a.movie_timescale=i.timescale,a.layer=r.tkhd.layer,a.alternate_group=r.tkhd.alternate_group,a.volume=r.tkhd.volume,a.matrix=r.tkhd.matrix,a.track_width=r.tkhd.width/65536,a.track_height=r.tkhd.height/65536,a.timescale=r.mdia.mdhd.timescale,a.cts_shift=r.mdia.minf.stbl.cslg,a.duration=r.mdia.mdhd.duration,a.samples_duration=r.samples_duration,a.codec=f.getCodec(),a.kind=r.udta&&r.udta.kinds.length?r.udta.kinds[0]:{schemeURI:"",value:""},a.language=r.mdia.elng?r.mdia.elng.extended_language:r.mdia.mdhd.languageString,a.nb_samples=r.samples.length,a.size=r.samples_size,a.bitrate=a.size*8*a.timescale/a.samples_duration,f.isAudio()?(a.type="audio",i.audioTracks.push(a),a.audio={},a.audio.sample_rate=f.getSampleRate(),a.audio.channel_count=f.getChannelCount(),a.audio.sample_size=f.getSampleSize()):f.isVideo()?(a.type="video",i.videoTracks.push(a),a.video={},a.video.width=f.getWidth(),a.video.height=f.getHeight()):f.isSubtitle()?(a.type="subtitles",i.subtitleTracks.push(a)):f.isHint()?(a.type="metadata",i.hintTracks.push(a)):f.isMetadata()?(a.type="metadata",i.metadataTracks.push(a)):(a.type="metadata",i.otherTracks.push(a))}else i.hasMoov=!1;if(i.mime="",i.hasMoov&&i.tracks){for(i.videoTracks&&i.videoTracks.length>0?i.mime+='video/mp4; codecs="':i.audioTracks&&i.audioTracks.length>0?i.mime+='audio/mp4; codecs="':i.mime+='application/mp4; codecs="',t=0;t<i.tracks.length;t++)t!==0&&(i.mime+=","),i.mime+=i.tracks[t].codec;i.mime+='"; profiles="',i.mime+=this.ftyp.compatible_brands.join(),i.mime+='"'}return i},y.prototype.processSamples=function(t){var e,i;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var r=this.fragmentedTracks[e];for(i=r.trak;i.nextSample<i.samples.length&&this.sampleProcessingStarted;){n.debug("ISOFile","Creating media fragment on track #"+r.id+" for sample "+i.nextSample);var a=this.createFragment(r.id,i.nextSample,r.segmentStream);if(a)r.segmentStream=a,i.nextSample++;else break;if((i.nextSample%r.nb_samples===0||t||i.nextSample>=i.samples.length)&&(n.info("ISOFile","Sending fragmented data on track #"+r.id+" for samples ["+Math.max(0,i.nextSample-r.nb_samples)+","+(i.nextSample-1)+"]"),n.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(r.id,r.user,r.segmentStream.buffer,i.nextSample,t||i.nextSample>=i.samples.length),r.segmentStream=null,r!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var p=this.extractedTracks[e];for(i=p.trak;i.nextSample<i.samples.length&&this.sampleProcessingStarted;){n.debug("ISOFile","Exporting on track #"+p.id+" sample #"+i.nextSample);var f=this.getSample(i,i.nextSample);if(f)i.nextSample++,p.samples.push(f);else break;if((i.nextSample%p.nb_samples===0||i.nextSample>=i.samples.length)&&(n.debug("ISOFile","Sending samples on track #"+p.id+" for sample "+i.nextSample),this.onSamples&&this.onSamples(p.id,p.user,p.samples),p.samples=[],p!==this.extractedTracks[e]))break}}}},y.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},y.prototype.getBoxes=function(t,e){var i=[];return y._sweep.call(this,t,i,e),i},y._sweep=function(t,e,i){this.type&&this.type==t&&e.push(this);for(var r in this.boxes){if(e.length&&i)return;y._sweep.call(this.boxes[r],t,e,i)}},y.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},y.prototype.getTrackSample=function(t,e){var i=this.getTrackById(t),r=this.getSample(i,e);return r},y.prototype.releaseUsedSamples=function(t,e){var i=0,r=this.getTrackById(t);r.lastValidSample||(r.lastValidSample=0);for(var a=r.lastValidSample;a<e;a++)i+=this.releaseSample(r,a);n.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+i+", remaining: "+this.samplesDataSize+")"),r.lastValidSample=e},y.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},y.prototype.stop=function(){this.sampleProcessingStarted=!1},y.prototype.flush=function(){n.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},y.prototype.seekTrack=function(t,e,i){var r,a,p=1/0,f=0,c=0,g;if(i.samples.length===0)return n.info("ISOFile","No sample in track, cannot seek! Using time "+n.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(r=0;r<i.samples.length;r++){if(a=i.samples[r],r===0)c=0,g=a.timescale;else if(a.cts>t*a.timescale){c=r-1;break}e&&a.is_sync&&(f=r)}for(e&&(c=f),t=i.samples[c].cts,i.nextSample=c;i.samples[c].alreadyRead===i.samples[c].size&&i.samples[c+1];)c++;return p=i.samples[c].offset+i.samples[c].alreadyRead,n.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+i.nextSample+" on track "+i.tkhd.track_id+", time "+n.getDurationString(t,g)+" and offset: "+p),{offset:p,time:t/g}},y.prototype.seek=function(t,e){var i=this.moov,r,a,p,f={offset:1/0,time:1/0};if(this.moov){for(p=0;p<i.traks.length;p++)r=i.traks[p],a=this.seekTrack(t,e,r),a.offset<f.offset&&(f.offset=a.offset),a.time<f.time&&(f.time=a.time);return n.info("ISOFile","Seeking at time "+n.getDurationString(f.time,1)+" needs a buffer with a fileStart position of "+f.offset),f.offset===1/0?f={offset:this.nextParsePosition,time:0}:f.offset=this.stream.getEndFilePositionAfter(f.offset),n.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+f.offset),f}else throw"Cannot seek: moov not received!"},y.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var i=this.boxes[e],r=t.boxes[e];if(!s.boxEqual(i,r))return!1;e++}return!0},l.ISOFile=y,y.prototype.lastBoxStartPosition=0,y.prototype.parsingMdat=null,y.prototype.nextParsePosition=0,y.prototype.discardMdatData=!1,y.prototype.processIncompleteBox=function(t){var e,i,r;return t.type==="mdat"?(e=new s[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,r=this.stream.seek(e.start+e.size,!1,this.discardMdatData),r?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),i=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,i?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},y.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},y.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(n.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},y.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},y.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},y.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},y.prototype.add=s.Box.prototype.add,y.prototype.addBox=s.Box.prototype.addBox,y.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var i=this.add("moov");return i.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),i.add("mvex"),this},y.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var i=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,i.add("tkhd").set("flags",s.TKHD_FLAG_ENABLED|s.TKHD_FLAG_IN_MOVIE|s.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",e.width<<16).set("height",e.height<<16);var r=i.add("mdia");r.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),r.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),r.add("elng").set("extended_language",e.language||"fr-FR");var a=r.add("minf");if(s[e.type+"SampleEntry"]!==void 0){var p=new s[e.type+"SampleEntry"];p.data_reference_index=1;var f="";for(var c in s.sampleEntryCodes)for(var g=s.sampleEntryCodes[c],w=0;w<g.length;w++)if(g.indexOf(e.type)>-1){f=c;break}switch(f){case"Visual":if(a.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),p.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var v=new s.avcCBox,U=new h(e.avcDecoderConfigRecord);v.parse(U),p.addBox(v)}break;case"Audio":a.add("smhd").set("balance",e.balance||0),p.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":a.add("hmhd");break;case"Subtitle":switch(a.add("sthd"),e.type){case"stpp":p.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":a.add("nmhd");break;case"System":a.add("nmhd");break;default:a.add("nmhd");break}e.description&&p.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(S){p.addBox(S)}),a.add("dinf").add("dref").addEntry(new s["url Box"]().set("flags",1));var I=a.add("stbl");return I.add("stsd").addEntry(p),I.add("stts").set("sample_counts",[]).set("sample_deltas",[]),I.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),I.add("stco").set("chunk_offsets",[]),I.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(i),e.id}},s.Box.prototype.computeSize=function(t){var e=t||new o;e.endianness=o.BIG_ENDIAN,this.write(e)},y.prototype.addSample=function(t,e,i){var r=i||{},a={},p=this.getTrackById(t);if(p!==null){a.number=p.samples.length,a.track_id=p.tkhd.track_id,a.timescale=p.mdia.mdhd.timescale,a.description_index=r.sample_description_index?r.sample_description_index-1:0,a.description=p.mdia.minf.stbl.stsd.entries[a.description_index],a.data=e,a.size=e.byteLength,a.alreadyRead=a.size,a.duration=r.duration||1,a.cts=r.cts||0,a.dts=r.dts||0,a.is_sync=r.is_sync||!1,a.is_leading=r.is_leading||0,a.depends_on=r.depends_on||0,a.is_depended_on=r.is_depended_on||0,a.has_redundancy=r.has_redundancy||0,a.degradation_priority=r.degradation_priority||0,a.offset=0,a.subsamples=r.subsamples,p.samples.push(a),p.samples_size+=a.size,p.samples_duration+=a.duration,p.first_dts||(p.first_dts=r.dts),this.processSamples();var f=this.createSingleSampleMoof(a);return this.addBox(f),f.computeSize(),f.trafs[0].truns[0].data_offset=f.size+8,this.add("mdat").data=new Uint8Array(e),a}},y.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var i=new s.moofBox;i.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var r=i.add("traf"),a=this.getTrackById(t.track_id);return r.add("tfhd").set("track_id",t.track_id).set("flags",s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),r.add("tfdt").set("baseMediaDecodeTime",t.dts-(a.first_dts||0)),r.add("trun").set("flags",s.TRUN_FLAGS_DATA_OFFSET|s.TRUN_FLAGS_DURATION|s.TRUN_FLAGS_SIZE|s.TRUN_FLAGS_FLAGS|s.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),i},y.prototype.lastMoofIndex=0,y.prototype.samplesDataSize=0,y.prototype.resetTables=function(){var t,e,i,r,a,p,f,c;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,i=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,i.chunk_offsets=[],r=e.mdia.minf.stbl.stsc,r.first_chunk=[],r.samples_per_chunk=[],r.sample_description_index=[],a=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,a.sample_sizes=[],p=e.mdia.minf.stbl.stts,p.sample_counts=[],p.sample_deltas=[],f=e.mdia.minf.stbl.ctts,f&&(f.sample_counts=[],f.sample_offsets=[]),c=e.mdia.minf.stbl.stss;var g=e.mdia.minf.stbl.boxes.indexOf(c);g!=-1&&(e.mdia.minf.stbl.boxes[g]=null)}},y.initSampleGroups=function(t,e,i,r,a){var p,f,c,g;function w(v,U,I){this.grouping_type=v,this.grouping_type_parameter=U,this.sbgp=I,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),f=0;f<i.length;f++){for(g=i[f].grouping_type+"/"+i[f].grouping_type_parameter,c=new w(i[f].grouping_type,i[f].grouping_type_parameter,i[f]),e&&(e.sample_groups_info[g]=c),t.sample_groups_info[g]||(t.sample_groups_info[g]=c),p=0;p<r.length;p++)r[p].grouping_type===i[f].grouping_type&&(c.description=r[p],c.description.used=!0);if(a)for(p=0;p<a.length;p++)a[p].grouping_type===i[f].grouping_type&&(c.fragment_description=a[p],c.fragment_description.used=!0,c.is_fragment=!0)}if(e){if(a)for(f=0;f<a.length;f++)!a[f].used&&a[f].version>=2&&(g=a[f].grouping_type+"/0",c=new w(a[f].grouping_type,0),c.is_fragment=!0,e.sample_groups_info[g]||(e.sample_groups_info[g]=c))}else for(f=0;f<r.length;f++)!r[f].used&&r[f].version>=2&&(g=r[f].grouping_type+"/0",c=new w(r[f].grouping_type,0),t.sample_groups_info[g]||(t.sample_groups_info[g]=c))},y.setSampleGroupProperties=function(t,e,i,r){var a,p;e.sample_groups=[];for(a in r)if(e.sample_groups[a]={},e.sample_groups[a].grouping_type=r[a].grouping_type,e.sample_groups[a].grouping_type_parameter=r[a].grouping_type_parameter,i>=r[a].last_sample_in_run&&(r[a].last_sample_in_run<0&&(r[a].last_sample_in_run=0),r[a].entry_index++,r[a].entry_index<=r[a].sbgp.entries.length-1&&(r[a].last_sample_in_run+=r[a].sbgp.entries[r[a].entry_index].sample_count)),r[a].entry_index<=r[a].sbgp.entries.length-1?e.sample_groups[a].group_description_index=r[a].sbgp.entries[r[a].entry_index].group_description_index:e.sample_groups[a].group_description_index=-1,e.sample_groups[a].group_description_index!==0){var f;r[a].fragment_description?f=r[a].fragment_description:f=r[a].description,e.sample_groups[a].group_description_index>0?(e.sample_groups[a].group_description_index>65535?p=(e.sample_groups[a].group_description_index>>16)-1:p=e.sample_groups[a].group_description_index-1,f&&p>=0&&(e.sample_groups[a].description=f.entries[p])):f&&f.version>=2&&f.default_group_description_index>0&&(e.sample_groups[a].description=f.entries[f.default_group_description_index-1])}},y.process_sdtp=function(t,e,i){e&&(t?(e.is_leading=t.is_leading[i],e.depends_on=t.sample_depends_on[i],e.is_depended_on=t.sample_is_depended_on[i],e.has_redundancy=t.sample_has_redundancy[i]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},y.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},y.prototype.buildTrakSampleLists=function(t){var e,i,r,a,p,f,c,g,w,v,U,I,S,T,C,ot,gt,it,M,j,Ct,jt,X,yt;if(t.samples=[],t.samples_duration=0,t.samples_size=0,i=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,r=t.mdia.minf.stbl.stsc,a=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,p=t.mdia.minf.stbl.stts,f=t.mdia.minf.stbl.ctts,c=t.mdia.minf.stbl.stss,g=t.mdia.minf.stbl.stsd,w=t.mdia.minf.stbl.subs,I=t.mdia.minf.stbl.stdp,v=t.mdia.minf.stbl.sbgps,U=t.mdia.minf.stbl.sgpds,it=-1,M=-1,j=-1,Ct=-1,jt=0,X=0,yt=0,y.initSampleGroups(t,null,v,U),!(typeof a>"u")){for(e=0;e<a.sample_sizes.length;e++){var B={};B.number=e,B.track_id=t.tkhd.track_id,B.timescale=t.mdia.mdhd.timescale,B.alreadyRead=0,t.samples[e]=B,B.size=a.sample_sizes[e],t.samples_size+=B.size,e===0?(T=1,S=0,B.chunk_index=T,B.chunk_run_index=S,gt=r.samples_per_chunk[S],ot=0,S+1<r.first_chunk.length?C=r.first_chunk[S+1]-1:C=1/0):e<gt?(B.chunk_index=T,B.chunk_run_index=S):(T++,B.chunk_index=T,ot=0,T<=C||(S++,S+1<r.first_chunk.length?C=r.first_chunk[S+1]-1:C=1/0),B.chunk_run_index=S,gt+=r.samples_per_chunk[S]),B.description_index=r.sample_description_index[B.chunk_run_index]-1,B.description=g.entries[B.description_index],B.offset=i.chunk_offsets[B.chunk_index-1]+ot,ot+=B.size,e>it&&(M++,it<0&&(it=0),it+=p.sample_counts[M]),e>0?(t.samples[e-1].duration=p.sample_deltas[M],t.samples_duration+=t.samples[e-1].duration,B.dts=t.samples[e-1].dts+t.samples[e-1].duration):B.dts=0,f?(e>=j&&(Ct++,j<0&&(j=0),j+=f.sample_counts[Ct]),B.cts=t.samples[e].dts+f.sample_offsets[Ct]):B.cts=B.dts,c?(e==c.sample_numbers[jt]-1?(B.is_sync=!0,jt++):(B.is_sync=!1,B.degradation_priority=0),w&&w.entries[X].sample_delta+yt==e+1&&(B.subsamples=w.entries[X].subsamples,yt+=w.entries[X].sample_delta,X++)):B.is_sync=!0,y.process_sdtp(t.mdia.minf.stbl.sdtp,B,B.number),I?B.degradation_priority=I.priority[e]:B.degradation_priority=0,w&&w.entries[X].sample_delta+yt==e&&(B.subsamples=w.entries[X].subsamples,yt+=w.entries[X].sample_delta),(v.length>0||U.length>0)&&y.setSampleGroupProperties(t,B,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},y.prototype.updateSampleLists=function(){var t,e,i,r,a,p,f,c,g,w,v,U,I,S,T;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(g=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,g.type=="moof")for(w=g,t=0;t<w.trafs.length;t++){for(v=w.trafs[t],U=this.getTrackById(v.tfhd.track_id),I=this.getTrexById(v.tfhd.track_id),v.tfhd.flags&s.TFHD_FLAG_SAMPLE_DESC?r=v.tfhd.default_sample_description_index:r=I?I.default_sample_description_index:1,v.tfhd.flags&s.TFHD_FLAG_SAMPLE_DUR?a=v.tfhd.default_sample_duration:a=I?I.default_sample_duration:0,v.tfhd.flags&s.TFHD_FLAG_SAMPLE_SIZE?p=v.tfhd.default_sample_size:p=I?I.default_sample_size:0,v.tfhd.flags&s.TFHD_FLAG_SAMPLE_FLAGS?f=v.tfhd.default_sample_flags:f=I?I.default_sample_flags:0,v.sample_number=0,v.sbgps.length>0&&y.initSampleGroups(U,v,v.sbgps,U.mdia.minf.stbl.sgpds,v.sgpds),e=0;e<v.truns.length;e++){var C=v.truns[e];for(i=0;i<C.sample_count;i++){S={},S.moof_number=this.lastMoofIndex,S.number_in_traf=v.sample_number,v.sample_number++,S.number=U.samples.length,v.first_sample_index=U.samples.length,U.samples.push(S),S.track_id=U.tkhd.track_id,S.timescale=U.mdia.mdhd.timescale,S.description_index=r-1,S.description=U.mdia.minf.stbl.stsd.entries[S.description_index],S.size=p,C.flags&s.TRUN_FLAGS_SIZE&&(S.size=C.sample_size[i]),U.samples_size+=S.size,S.duration=a,C.flags&s.TRUN_FLAGS_DURATION&&(S.duration=C.sample_duration[i]),U.samples_duration+=S.duration,U.first_traf_merged||i>0?S.dts=U.samples[U.samples.length-2].dts+U.samples[U.samples.length-2].duration:(v.tfdt?S.dts=v.tfdt.baseMediaDecodeTime:S.dts=0,U.first_traf_merged=!0),S.cts=S.dts,C.flags&s.TRUN_FLAGS_CTS_OFFSET&&(S.cts=S.dts+C.sample_composition_time_offset[i]),T=f,C.flags&s.TRUN_FLAGS_FLAGS?T=C.sample_flags[i]:i===0&&C.flags&s.TRUN_FLAGS_FIRST_FLAG&&(T=C.first_sample_flags),S.is_sync=!(T>>16&1),S.is_leading=T>>26&3,S.depends_on=T>>24&3,S.is_depended_on=T>>22&3,S.has_redundancy=T>>20&3,S.degradation_priority=T&65535;var ot=!!(v.tfhd.flags&s.TFHD_FLAG_BASE_DATA_OFFSET),gt=!!(v.tfhd.flags&s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),it=!!(C.flags&s.TRUN_FLAGS_DATA_OFFSET),M=0;ot?M=v.tfhd.base_data_offset:gt||e===0?M=w.start:M=c,e===0&&i===0?it?S.offset=M+C.data_offset:S.offset=M:S.offset=c,c=S.offset+S.size,(v.sbgps.length>0||v.sgpds.length>0||U.mdia.minf.stbl.sbgps.length>0||U.mdia.minf.stbl.sgpds.length>0)&&y.setSampleGroupProperties(U,S,S.number_in_traf,v.sample_groups_info)}}if(v.subs){U.has_fragment_subsamples=!0;var j=v.first_sample_index;for(e=0;e<v.subs.entries.length;e++)j+=v.subs.entries[e].sample_delta,S=U.samples[j-1],S.subsamples=v.subs.entries[e].subsamples}}}},y.prototype.getSample=function(t,e){var i,r=t.samples[e];if(!this.moov)return null;if(!r.data)r.data=new Uint8Array(r.size),r.alreadyRead=0,this.samplesDataSize+=r.size,n.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+r.size+" (total: "+this.samplesDataSize+")");else if(r.alreadyRead==r.size)return r;for(;;){var a=this.stream.findPosition(!0,r.offset+r.alreadyRead,!1);if(a>-1){i=this.stream.buffers[a];var p=i.byteLength-(r.offset+r.alreadyRead-i.fileStart);if(r.size-r.alreadyRead<=p)return n.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+r.alreadyRead+" offset: "+(r.offset+r.alreadyRead-i.fileStart)+" read size: "+(r.size-r.alreadyRead)+" full size: "+r.size+")"),o.memcpy(r.data.buffer,r.alreadyRead,i,r.offset+r.alreadyRead-i.fileStart,r.size-r.alreadyRead),i.usedBytes+=r.size-r.alreadyRead,this.stream.logBufferLevel(),r.alreadyRead=r.size,r;if(p===0)return null;n.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+r.alreadyRead+" offset: "+(r.offset+r.alreadyRead-i.fileStart)+" read size: "+p+" full size: "+r.size+")"),o.memcpy(r.data.buffer,r.alreadyRead,i,r.offset+r.alreadyRead-i.fileStart,p),r.alreadyRead+=p,i.usedBytes+=p,this.stream.logBufferLevel()}else return null}},y.prototype.releaseSample=function(t,e){var i=t.samples[e];return i.data?(this.samplesDataSize-=i.size,i.data=null,i.alreadyRead=0,i.size):0},y.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},y.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var i=this.moov.traks[t];t>0&&(e+=","),e+=i.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},y.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var i=this.moov.mvex.trexs[e];if(i.track_id==t)return i}return null},y.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var i=this.moov.traks[e];if(i.tkhd.track_id==t)return i}return null},y.prototype.items=[],y.prototype.itemsDataSize=0,y.prototype.flattenItemInfo=function(){var t=this.items,e,i,r,a=this.meta;if(a!=null&&a.hdlr!==void 0&&a.iinf!==void 0){for(e=0;e<a.iinf.item_infos.length;e++)r={},r.id=a.iinf.item_infos[e].item_ID,t[r.id]=r,r.ref_to=[],r.name=a.iinf.item_infos[e].item_name,a.iinf.item_infos[e].protection_index>0&&(r.protection=a.ipro.protections[a.iinf.item_infos[e].protection_index-1]),a.iinf.item_infos[e].item_type?r.type=a.iinf.item_infos[e].item_type:r.type="mime",r.content_type=a.iinf.item_infos[e].content_type,r.content_encoding=a.iinf.item_infos[e].content_encoding;if(a.iloc)for(e=0;e<a.iloc.items.length;e++){var p=a.iloc.items[e];switch(r=t[p.item_ID],p.data_reference_index!==0&&(n.warn("Item storage with reference to other files: not supported"),r.source=a.dinf.boxes[p.data_reference_index-1]),p.construction_method){case 0:break;case 1:n.warn("Item storage with construction_method : not supported");break;case 2:n.warn("Item storage with construction_method : not supported");break}for(r.extents=[],r.size=0,i=0;i<p.extents.length;i++)r.extents[i]={},r.extents[i].offset=p.extents[i].extent_offset+p.base_offset,r.extents[i].length=p.extents[i].extent_length,r.extents[i].alreadyRead=0,r.size+=r.extents[i].length}if(a.pitm&&(t[a.pitm.item_id].primary=!0),a.iref)for(e=0;e<a.iref.references.length;e++){var f=a.iref.references[e];for(i=0;i<f.references.length;i++)t[f.from_item_ID].ref_to.push({type:f.type,id:f.references[i]})}if(a.iprp)for(var c=0;c<a.iprp.ipmas.length;c++){var g=a.iprp.ipmas[c];for(e=0;e<g.associations.length;e++){var w=g.associations[e];for(r=t[w.id],r.properties===void 0&&(r.properties={},r.properties.boxes=[]),i=0;i<w.props.length;i++){var v=w.props[i];if(v.property_index>0&&v.property_index-1<a.iprp.ipco.boxes.length){var U=a.iprp.ipco.boxes[v.property_index-1];r.properties[U.type]=U,r.properties.boxes.push(U)}}}}}},y.prototype.getItem=function(t){var e,i;if(!this.meta)return null;if(i=this.items[t],!i.data&&i.size)i.data=new Uint8Array(i.size),i.alreadyRead=0,this.itemsDataSize+=i.size,n.debug("ISOFile","Allocating item #"+t+" of size "+i.size+" (total: "+this.itemsDataSize+")");else if(i.alreadyRead===i.size)return i;for(var r=0;r<i.extents.length;r++){var a=i.extents[r];if(a.alreadyRead!==a.length){var p=this.stream.findPosition(!0,a.offset+a.alreadyRead,!1);if(p>-1){e=this.stream.buffers[p];var f=e.byteLength-(a.offset+a.alreadyRead-e.fileStart);if(a.length-a.alreadyRead<=f)n.debug("ISOFile","Getting item #"+t+" extent #"+r+" data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-e.fileStart)+" read size: "+(a.length-a.alreadyRead)+" full extent size: "+a.length+" full item size: "+i.size+")"),o.memcpy(i.data.buffer,i.alreadyRead,e,a.offset+a.alreadyRead-e.fileStart,a.length-a.alreadyRead),e.usedBytes+=a.length-a.alreadyRead,this.stream.logBufferLevel(),i.alreadyRead+=a.length-a.alreadyRead,a.alreadyRead=a.length;else return n.debug("ISOFile","Getting item #"+t+" extent #"+r+" partial data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-e.fileStart)+" read size: "+f+" full extent size: "+a.length+" full item size: "+i.size+")"),o.memcpy(i.data.buffer,i.alreadyRead,e,a.offset+a.alreadyRead-e.fileStart,f),a.alreadyRead+=f,i.alreadyRead+=f,e.usedBytes+=f,this.stream.logBufferLevel(),null}else return null}}return i.alreadyRead===i.size?i:null},y.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var i=0;i<e.extents.length;i++){var r=e.extents[i];r.alreadyRead=0}return e.size}else return 0},y.prototype.processItems=function(t){for(var e in this.items){var i=this.items[e];this.getItem(i.id),t&&!i.sent&&(t(i),i.sent=!0,i.data=null)}},y.prototype.hasItem=function(t){for(var e in this.items){var i=this.items[e];if(i.name===t)return i.id}return-1},y.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},y.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},y.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},i=null;if(e.itemId?i=this.getItem(e.itemId):i=this.getPrimaryItem(),i==null)return null;var r=new y;r.discardMdatData=!1;var a={type:i.type,description_boxes:i.properties.boxes};i.properties.ispe&&(a.width=i.properties.ispe.image_width,a.height=i.properties.ispe.image_height);var p=r.addTrack(a);return p?(r.addSample(p,i.data),r):null},y.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},y.prototype.createFragment=function(t,e,i){var r=this.getTrackById(t),a=this.getSample(r,e);if(a==null)return a=r.samples[e],this.nextSeekPosition?this.nextSeekPosition=Math.min(a.offset+a.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=r.samples[e].offset+a.alreadyRead,null;var p=i||new o;p.endianness=o.BIG_ENDIAN;var f=this.createSingleSampleMoof(a);f.write(p),f.trafs[0].truns[0].data_offset=f.size+8,n.debug("MP4Box","Adjusting data_offset with new value "+f.trafs[0].truns[0].data_offset),p.adjustUint32(f.trafs[0].truns[0].data_offset_position,f.trafs[0].truns[0].data_offset);var c=new s.mdatBox;return c.data=a.data,c.write(p),p},y.writeInitializationSegment=function(t,e,i,r){var a;n.debug("ISOFile","Generating initialization segment");var p=new o;p.endianness=o.BIG_ENDIAN,t.write(p);var f=e.add("mvex");for(i&&f.add("mehd").set("fragment_duration",i),a=0;a<e.traks.length;a++)f.add("trex").set("track_id",e.traks[a].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",r).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(p),p.buffer},y.prototype.save=function(t){var e=new o;e.endianness=o.BIG_ENDIAN,this.write(e),e.save(t)},y.prototype.getBuffer=function(){var t=new o;return t.endianness=o.BIG_ENDIAN,this.write(t),t.buffer},y.prototype.initializeSegmentation=function(){var t,e,i,r;for(this.onSegment===null&&n.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var a=new s.moovBox;a.mvhd=this.moov.mvhd,a.boxes.push(a.mvhd),i=this.getTrackById(this.fragmentedTracks[t].id),a.boxes.push(i),a.traks.push(i),r={},r.id=i.tkhd.track_id,r.user=this.fragmentedTracks[t].user,r.buffer=y.writeInitializationSegment(this.ftyp,a,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(r)}return e},s.Box.prototype.printHeader=function(t){this.size+=8,this.size>d&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},s.FullBox.prototype.printHeader=function(t){this.size+=4,s.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},s.Box.prototype.print=function(t){this.printHeader(t)},s.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var i=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=i}},y.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},s.mvhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},s.tkhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var P={};P.createFile=function(t,e){var i=t!==void 0?t:!0,r=new y(e);return r.discardMdatData=!i,r},l.createFile=P.createFile})(Ie);const $t=pi(Ie),mt={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};function fi(l,n){const h=n.videoTracks[0],o={};if(h!=null){const u=ui(l.getTrackById(h.id)).buffer,{descKey:_,type:s}=h.codec.startsWith("avc1")?{descKey:"avcDecoderConfigRecord",type:"avc1"}:h.codec.startsWith("hvc1")?{descKey:"hevcDecoderConfigRecord",type:"hvc1"}:{descKey:"",type:""};_!==""&&(o.videoTrackConf={timescale:h.timescale,duration:h.duration,width:h.video.width,height:h.video.height,brands:n.brands,type:s,[_]:u}),o.videoDecoderConf={codec:h.codec,codedHeight:h.video.height,codedWidth:h.video.width,description:u}}const d=n.audioTracks[0];if(d!=null){const u=pe(l);o.audioTrackConf={timescale:d.timescale,samplerate:d.audio.sample_rate,channel_count:d.audio.channel_count,hdlr:"soun",type:d.codec.startsWith("mp4a")?"mp4a":d.codec,description:pe(l)},o.audioDecoderConf={codec:d.codec.startsWith("mp4a")?mt.codec:d.codec,numberOfChannels:d.audio.channel_count,sampleRate:d.audio.sample_rate,...u==null?{}:ci(u)}}return o}function ui(l){for(const n of l.mdia.minf.stbl.stsd.entries){const h=n.avcC??n.hvcC??n.vpcC;if(h!=null){const o=new $t.DataStream(void 0,0,$t.DataStream.BIG_ENDIAN);return h.write(o),new Uint8Array(o.buffer.slice(8))}}throw Error("avcC, hvcC or VPX not found")}function pe(l,n="mp4a"){var h;const o=(h=l.moov)==null?void 0:h.traks.map(d=>d.mdia.minf.stbl.stsd.entries).flat().find(({type:d})=>d===n);return o==null?void 0:o.esds}function ci(l){var n;const h=(n=l.esd.descs[0])==null?void 0:n.descs[0];if(h==null)return{};const[o,d]=h.data,u=((o&7)<<1)+(d>>7),_=(d&127)>>3;return{sampleRate:[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][u],numberOfChannels:_}}var Ut;class _i{constructor(){et(this,"readable"),et(this,"writable"),A(this,Ut,0);const n=$t.createFile();let h=!1;this.readable=new ReadableStream({start:o=>{n.onReady=u=>{var _,s;const b=(_=u.videoTracks[0])==null?void 0:_.id;b!=null&&n.setExtractionOptions(b,"video",{nbSamples:100});const x=(s=u.audioTracks[0])==null?void 0:s.id;x!=null&&n.setExtractionOptions(x,"audio",{nbSamples:100}),o.enqueue({chunkType:"ready",data:{info:u,file:n}}),n.start()};const d={};n.onSamples=(u,_,s)=>{o.enqueue({chunkType:"samples",data:{id:u,type:_,samples:s.map(b=>({...b}))}}),d[u]=(d[u]??0)+s.length,n.releaseUsedSamples(u,d[u])},n.onFlush=()=>{o.close()}},cancel:()=>{n.stop(),h=!0}},{highWaterMark:50}),this.writable=new WritableStream({write:async o=>{if(h){this.writable.abort();return}const d=o.buffer;d.fileStart=m(this,Ut),E(this,Ut,m(this,Ut)+d.byteLength),n.appendBuffer(d)},close:()=>{var o;n.flush(),n.stop(),(o=n.onFlush)==null||o.call(n)}})}}Ut=new WeakMap;let mi=0;function Kt(l){return l.kind==="file"&&l.createReader instanceof Function}var Rt,Dt,G,Q,Mt,st,xt,Et,At,Y,J;class Ai{constructor(n,h={}){if(A(this,Rt,k.create(`MP4Clip id:${mi++},`)),et(this,"ready"),A(this,Dt,!1),A(this,G,{duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0}),A(this,Q),A(this,Mt,1),A(this,st,[]),A(this,xt,null),A(this,Et,null),A(this,At,{video:null,audio:null}),A(this,Y,{audio:!0}),et(this,"tickInterceptor",async(d,u)=>u),A(this,J,new AbortController),!(n instanceof ReadableStream)&&!Kt(n)&&!Array.isArray(n.videoSamples))throw Error("Illegal argument");E(this,Y,{audio:!0,...h}),E(this,Mt,typeof h.audio=="object"&&"volume"in h.audio?h.audio.volume:1);const o=async d=>(await re(m(this,Q),d),await m(this,Q).stream());E(this,Q,Kt(n)?n:"localFile"in n?n.localFile:xe()),this.ready=(n instanceof ReadableStream?o(n).then(d=>fe(d,m(this,Y))):Kt(n)?n.stream().then(d=>fe(d,m(this,Y))):Promise.resolve(n)).then(async({videoSamples:d,audioSamples:u,decoderConf:_})=>{E(this,st,d),E(this,At,_);const{videoFrameFinder:s,audioFrameFinder:b}=yi({video:_.video==null?null:{..._.video,hardwareAcceleration:m(this,Y).__unsafe_hardwareAcceleration__},audio:_.audio},await m(this,Q).createReader(),d,u,m(this,Y).audio!==!1?m(this,Mt):0);return E(this,xt,s),E(this,Et,b),E(this,G,gi(_,d,u)),m(this,Rt).info("MP4Clip meta:",m(this,G)),{...m(this,G)}})}get meta(){return{...m(this,G)}}async tick(n){var h,o;if(n>=m(this,G).duration)return await this.tickInterceptor(n,{audio:[],state:"done"});const[d,u]=await Promise.all([((h=m(this,Et))==null?void 0:h.find(n))??[],(o=m(this,xt))==null?void 0:o.find(n)]);return u==null?await this.tickInterceptor(n,{audio:d,state:"success"}):await this.tickInterceptor(n,{video:u,audio:d,state:"success"})}async thumbnails(n=100,h){m(this,J).abort(),E(this,J,new AbortController);const o=m(this,J).signal;await this.ready;const d="generate thumbnails aborted";if(o.aborted)throw Error(d);const{width:u,height:_}=m(this,G),s=ue(n,Math.round(_*(n/u)),{quality:.1,type:"image/png"});return new Promise(async(b,x)=>{let y=[];const P=m(this,At).video;if(P==null||m(this,st).length===0){t();return}o.addEventListener("abort",()=>{x(Error(d))});async function t(){o.aborted||b(await Promise.all(y.map(async c=>({ts:c.ts,img:await c.img}))))}function e(c){y.push({ts:c.timestamp,img:s(c)})}const{start:i=0,end:r=m(this,G).duration,step:a=1e6}=h??{};let p=i;const f=new ee(await m(this,Q).createReader(),m(this,st),{...P,hardwareAcceleration:m(this,Y).__unsafe_hardwareAcceleration__});for(;p<=r&&!o.aborted;){const c=await f.find(p);c&&e(c),p+=a}f.destroy(),t()})}async thumbnailsList(n=100,h){var o;if(((o=h==null?void 0:h.timestamps)==null?void 0:o.length)===0)return[];m(this,J).abort(),E(this,J,new AbortController);const d=m(this,J).signal;await this.ready;const u="generate thumbnails aborted";if(d.aborted)throw Error(u);const{width:_,height:s}=m(this,G),b=ue(n,Math.round(s*(n/_)),{quality:.1,type:"image/png"});return new Promise(async(x,y)=>{let P=[];const t=m(this,At).video;if(t==null||m(this,st).length===0){e();return}d.addEventListener("abort",()=>{y(Error(u))});async function e(){d.aborted||x(await Promise.all(P.map(async p=>({ts:p.ts,img:await p.img}))))}function i(p){P.push({ts:p.timestamp,img:b(p)})}const r=(h==null?void 0:h.timestamps)??[];if(r.length===0){e();return}const a=new ee(await m(this,Q).createReader(),m(this,st),{...t,hardwareAcceleration:m(this,Y).__unsafe_hardwareAcceleration__});for(const p of r){if(d.aborted)break;const f=await a.find(p);f&&i(f)}a.destroy(),e()})}destroy(){var n,h;m(this,Dt)||(m(this,Rt).info("MP4Clip destroy"),E(this,Dt,!0),(n=m(this,xt))==null||n.destroy(),(h=m(this,Et))==null||h.destroy())}}Rt=new WeakMap,Dt=new WeakMap,G=new WeakMap,Q=new WeakMap,Mt=new WeakMap,st=new WeakMap,xt=new WeakMap,Et=new WeakMap,At=new WeakMap,Y=new WeakMap,J=new WeakMap;function gi(l,n,h){const o={duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0};l.video!=null&&n.length>0&&(o.width=l.video.codedWidth??0,o.height=l.video.codedHeight??0),l.audio!=null&&h.length>0&&(o.audioSampleRate=mt.sampleRate,o.audioChanCount=mt.channelCount);let d=0,u=0;if(n.length>0)for(let _=n.length-1;_>=0;_--){const s=n[_];if(!s.deleted){d=s.cts+s.duration;break}}if(h.length>0){const _=h.at(-1);u=_.cts+_.duration}return o.duration=Math.max(d,u),o}function yi(l,n,h,o,d){return{audioFrameFinder:d===0||l.audio==null||o.length===0?null:new bi(n,o,l.audio,{volume:d,targetSampleRate:mt.sampleRate}),videoFrameFinder:l.video==null||h.length===0?null:new ee(n,h,l.video)}}async function fe(l,n={}){let h;const o={video:null,audio:null};let d=[],u=[];return new Promise(async(s,b)=>{let x=-1,y=-1;const P=di(l.pipeThrough(new _i),{onChunk:async({chunkType:t,data:e})=>{if(t==="ready"){h=e.info;let{videoDecoderConf:i,audioDecoderConf:r}=fi(e.file,e.info);o.video=i??null,o.audio=r??null,i==null&&r==null&&(P(),b(Error("MP4Clip must contain at least one video or audio track"))),k.info("mp4BoxFile moov ready",{...e.info,tracks:null,videoTracks:null,audioTracks:null},o)}else if(t==="samples"){if(e.type==="video"){x===-1&&(x=e.samples[0].dts);for(const i of e.samples)d.push(_(i,x,"video"))}else if(e.type==="audio"&&n.audio){y===-1&&(y=e.samples[0].dts);for(const i of e.samples)u.push(_(i,y,"audio"))}}},onDone:()=>{const t=d.at(-1)??u.at(-1);if(h==null){b(Error("MP4Clip stream is done, but not emit ready"));return}else if(t==null){b(Error("MP4Clip stream not contain any sample"));return}const e=d[0];e!=null&&e.cts<2e5&&(e.duration+=e.cts,e.cts=0),k.info("mp4 stream parsed"),s({videoSamples:d,audioSamples:u,decoderConf:o})}})});function _(s,b=0,x){return{...s,is_idr:x==="video"&&s.is_sync&&Ei(s.data,s.description.type),cts:(s.cts-b)/s.timescale*1e6,dts:(s.dts-b)/s.timescale*1e6,duration:s.duration/s.timescale*1e6,timescale:1e6,data:x==="video"?null:s.data}}}var F,lt,dt,Nt,pt,H,L,q,rt,Bt,nt,Ot,ft,te;class ee{constructor(n,h,o){A(this,F,null),A(this,lt,0),A(this,dt,{abort:!1,st:performance.now()}),et(this,"find",async d=>((m(this,F)==null||d<=m(this,lt)||d-m(this,lt)>3e6)&&m(this,ft).call(this,d),m(this,dt).abort=!0,E(this,lt,d),E(this,dt,{abort:!1,st:performance.now()}),await m(this,Bt).call(this,d,m(this,F),m(this,dt)))),A(this,Nt,0),A(this,pt,!1),A(this,H,0),A(this,L,[]),A(this,q,0),A(this,rt,0),A(this,Bt,async(d,u,_)=>{if(u==null||u.state==="closed"||_.abort)return null;if(m(this,L).length>0){const s=m(this,L)[0];return d<s.timestamp?null:(m(this,L).shift(),d>s.timestamp+(s.duration??0)?(s.close(),await m(this,Bt).call(this,d,u,_)):(m(this,L).length<10&&m(this,Ot).call(this,u).catch(b=>{throw m(this,ft).call(this,d),b}),s))}if(m(this,nt)||m(this,q)<m(this,rt)&&u.decodeQueueSize>0){if(performance.now()-_.st>6e3)throw Error(`MP4Clip.tick video timeout, ${JSON.stringify(m(this,te).call(this))}`);await ze(15)}else{if(m(this,H)>=this.samples.length)return null;try{await m(this,Ot).call(this,u)}catch(s){throw m(this,ft).call(this,d),s}}return await m(this,Bt).call(this,d,u,_)}),A(this,nt,!1),A(this,Ot,async d=>{var u,_;if(m(this,nt))return;E(this,nt,!0);let s=m(this,H)+1,b=!1;for(;s<this.samples.length;s++){const x=this.samples[s];if(!b&&!x.deleted&&(b=!0),x.is_idr)break}if(b){const x=this.samples.slice(m(this,H),s);if(((u=x[0])==null?void 0:u.is_idr)!==!0)k.warn("First sample not idr frame");else{const y=await Ui(x,this.localFileReader);if(d.state==="closed")return;E(this,Nt,((_=y[0])==null?void 0:_.duration)??0),xi(d,y,{onDecodingError:P=>{if(m(this,pt))throw P;m(this,q)===0&&(E(this,pt,!0),k.warn("Downgrade to software decode"),m(this,ft).call(this))}}),E(this,rt,m(this,rt)+y.length)}}E(this,H,s),E(this,nt,!1)}),A(this,ft,d=>{var u,_;if(E(this,nt,!1),m(this,L).forEach(s=>s.close()),E(this,L,[]),d==null||d===0)E(this,H,0);else{let s=0;for(let b=0;b<this.samples.length;b++){const x=this.samples[b];if(x.is_idr&&(s=b),!(x.cts<d)){E(this,H,s);break}}}E(this,rt,0),E(this,q,0),((u=m(this,F))==null?void 0:u.state)!=="closed"&&((_=m(this,F))==null||_.close()),E(this,F,new VideoDecoder({output:s=>{if(E(this,q,m(this,q)+1),s.timestamp===-1){s.close();return}let b=s;s.duration==null&&(b=new VideoFrame(s,{duration:m(this,Nt)}),s.close()),m(this,L).push(b)},error:s=>{k.error(`MP4Clip VideoDecoder err: ${s.message}`)}})),m(this,F).configure({...this.conf,...m(this,pt)?{hardwareAcceleration:"prefer-software"}:{}})}),A(this,te,()=>{var d,u;return{time:m(this,lt),decState:(d=m(this,F))==null?void 0:d.state,decQSize:(u=m(this,F))==null?void 0:u.decodeQueueSize,decCusorIdx:m(this,H),sampleLen:this.samples.length,inputCnt:m(this,rt),outputCnt:m(this,q),cacheFrameLen:m(this,L).length,softDeocde:m(this,pt)}}),et(this,"destroy",()=>{var d,u;((d=m(this,F))==null?void 0:d.state)!=="closed"&&((u=m(this,F))==null||u.close()),E(this,F,null),m(this,dt).abort=!0,m(this,L).forEach(_=>_.close()),E(this,L,[]),this.localFileReader.close()}),this.localFileReader=n,this.samples=h,this.conf=o}}F=new WeakMap,lt=new WeakMap,dt=new WeakMap,Nt=new WeakMap,pt=new WeakMap,H=new WeakMap,L=new WeakMap,q=new WeakMap,rt=new WeakMap,Bt=new WeakMap,nt=new WeakMap,Ot=new WeakMap,ft=new WeakMap,te=new WeakMap;var Gt,Yt,W,ut,V,$,Z,Ht,Wt,ie,se;class bi{constructor(n,h,o,d){A(this,Gt,1),A(this,Yt),A(this,W,null),A(this,ut,{abort:!1,st:performance.now()}),et(this,"find",async u=>{if(m(this,W)==null||u<=m(this,V)||u-m(this,V)>1e5){m(this,ie).call(this),E(this,V,u);for(let s=0;s<this.samples.length;s++)if(!(this.samples[s].cts<u)){E(this,$,s);break}return[]}m(this,ut).abort=!0;const _=u-m(this,V);return E(this,V,u),E(this,ut,{abort:!1,st:performance.now()}),await m(this,Ht).call(this,_,m(this,W),m(this,ut))}),A(this,V,0),A(this,$,0),A(this,Z,{frameCnt:0,data:[]}),A(this,Ht,async(u,_=null,s)=>{if(_==null||s.abort||_.state==="closed")return[];const b=Math.ceil(u*(m(this,Yt)/1e6));if(b===0)return[];const x=m(this,Z).frameCnt-b;if(x>0)return x<mt.sampleRate/10&&m(this,Wt).call(this,_),Si(m(this,Z),b);if(_.decodeQueueSize>10){if(performance.now()-s.st>3e3)throw s.abort=!0,Error(`MP4Clip.tick audio timeout, ${JSON.stringify(m(this,se).call(this))}`);await ze(15)}else{if(m(this,$)>=this.samples.length-1)return[];m(this,Wt).call(this,_)}return m(this,Ht).call(this,u,_,s)}),A(this,Wt,u=>{if(u.decodeQueueSize>100)return;const _=[];let s=m(this,$);for(;s<this.samples.length;){const b=this.samples[s];if(s+=1,!b.deleted&&(_.push(b),_.length>=10))break}E(this,$,s),u.decode(_.map(b=>new EncodedAudioChunk({type:"key",timestamp:b.cts,duration:b.duration,data:b.data})))}),A(this,ie,()=>{var u;E(this,V,0),E(this,$,0),E(this,Z,{frameCnt:0,data:[]}),(u=m(this,W))==null||u.close(),E(this,W,vi(this.conf,{resampleRate:mt.sampleRate,volume:m(this,Gt)},_=>{m(this,Z).data.push(_),m(this,Z).frameCnt+=_[0].length}))}),A(this,se,()=>{var u,_;return{time:m(this,V),decState:(u=m(this,W))==null?void 0:u.state,decQSize:(_=m(this,W))==null?void 0:_.decodeQueueSize,decCusorIdx:m(this,$),sampleLen:this.samples.length,pcmLen:m(this,Z).frameCnt}}),et(this,"destroy",()=>{E(this,W,null),m(this,ut).abort=!0,E(this,Z,{frameCnt:0,data:[]}),this.localFileReader.close()}),this.localFileReader=n,this.samples=h,this.conf=o,E(this,Gt,d.volume),E(this,Yt,d.targetSampleRate)}}Gt=new WeakMap,Yt=new WeakMap,W=new WeakMap,ut=new WeakMap,V=new WeakMap,$=new WeakMap,Z=new WeakMap,Ht=new WeakMap,Wt=new WeakMap,ie=new WeakMap,se=new WeakMap;function vi(l,n,h){const o=s=>{if(s.length!==0){if(n.volume!==1)for(const b of s)for(let x=0;x<b.length;x++)b[x]*=n.volume;s.length===1&&(s=[s[0],s[0]]),h(s)}},d=wi(o),u=n.resampleRate!==l.sampleRate,_=new AudioDecoder({output:s=>{const b=ni(s);u?d(()=>li(b,s.sampleRate,{rate:n.resampleRate,chanCount:s.numberOfChannels})):o(b),s.close()},error:s=>{k.error(`MP4Clip AudioDecoder err: ${s.message}`)}});return _.configure(l),{decode(s){for(const b of s)_.decode(b)},close(){_.state!=="closed"&&_.close()},get state(){return _.state},get decodeQueueSize(){return _.decodeQueueSize}}}function wi(l){const n=[];let h=0;function o(_,s){n[s]=_,d()}function d(){const _=n[h];_!=null&&(l(_),h+=1,d())}let u=0;return _=>{const s=u;u+=1,_().then(b=>o(b,s)).catch(b=>o(b,s))}}function Si(l,n){const h=[new Float32Array(n),new Float32Array(n)];let o=0,d=0;for(;d<l.data.length;){const[u,_]=l.data[d];if(o+u.length>n){const s=n-o;h[0].set(u.subarray(0,s),o),h[1].set(_.subarray(0,s),o),l.data[d][0]=u.subarray(s,u.length),l.data[d][1]=_.subarray(s,_.length);break}else h[0].set(u,o),h[1].set(_,o),o+=u.length,d++}return l.data=l.data.slice(d),l.frameCnt-=n,h}async function Ui(l,n){const h=l[0],o=l.at(-1);if(o==null)return[];const d=o.offset+o.size-h.offset;if(d<3e7){const u=new Uint8Array(await n.read(d,{at:h.offset}));return l.map(_=>{const s=_.offset-h.offset;let b=u.subarray(s,s+_.size);return _.is_idr&&(b=ce(b)),new EncodedVideoChunk({type:_.is_sync?"key":"delta",timestamp:_.cts,duration:_.duration,data:b})})}return await Promise.all(l.map(async u=>{let _=await n.read(u.size,{at:u.offset});return u.is_idr&&(_=ce(new Uint8Array(_))),new EncodedVideoChunk({type:u.is_sync?"key":"delta",timestamp:u.cts,duration:u.duration,data:_})}))}function ue(l,n,h){const o=new OffscreenCanvas(l,n),d=o.getContext("2d");return async u=>(d.drawImage(u,0,0,l,n),u.close(),await o.convertToBlob(h))}function xi(l,n,h){let o=0;if(l.state==="configured"){for(;o<n.length;o++)l.decode(n[o]);l.flush().catch(d=>{if(!(d instanceof Error))throw d;if(d.message.includes("Decoding error")&&h.onDecodingError!=null){h.onDecodingError(d);return}if(!d.message.includes("Aborted due to close"))throw d})}}function ce(l){const n=new DataView(l.buffer,l.byteOffset,l.byteLength);return(n.getUint8(4)&31)===6?l.subarray(n.getUint32(0)+4):l}function Ei(l,n){if(n!=="avc1"&&n!=="hvc1")return!1;const h=new DataView(l.buffer);let o=0;for(;o<l.byteLength-4;){if(n==="avc1"){if((h.getUint8(o+4)&31)===5)return!0}else if(n==="hvc1"&&(h.getUint8(o+4)>>1&63)===20)return!0;o+=h.getUint32(o)+4}return!1}export{mt as DEFAULT_AUDIO_CONF,k as Log,Ai as MP4Clip,li as audioResample,di as autoReadStream,hi as extractPCM4AudioBuffer,ni as extractPCM4AudioData,je as workerTimer};
